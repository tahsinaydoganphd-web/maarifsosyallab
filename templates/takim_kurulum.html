<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TakÄ±m YarÄ±ÅŸmasÄ± Kurulumu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
        select:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .team-list-item { background-color: #d1fae5; padding: 4px; border-radius: 4px; margin-bottom: 4px; }
        
        /* ğŸ‘‡ğŸ‘‡ğŸ‘‡ YENÄ° EKLENEN STÄ°LLER ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
        .student-item { 
            padding: 6px; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.1s;
        }
        .student-item:hover { background-color: #f0f9ff; }
        .student-item.selected { 
            background-color: #d1fae5; /* YeÅŸilimsi arka plan */
            font-weight: 600; 
            border: 1px solid #10b981; /* YeÅŸil kenarlÄ±k */
        }
        .student-item.assigned { 
            opacity: 0.6; 
            cursor: not-allowed; 
            background-color: #f3f4f6;
        }
        /* ğŸ‘†ğŸ‘†ğŸ‘† YENÄ° EKLENEN STÄ°LLER BÄ°TTÄ° ğŸ‘†ğŸ‘†ğŸ‘† */

        /* YENÄ° EKLENEN KURAL (macOS esnemesini durdurur) */
        .no-bounce {
            overscroll-behavior: none;
        }
    </style>
</head>
<body class="flex h-screen">
    
    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
    <div class="px-6 py-4 border-b border-gray-200">
        <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">Maarif SosyalLab</h1>
        <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png"  
                         alt="Maarif Logo" 
                         class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>
        <div class="flex items-center">
            <div id="user-avatar-initial" class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">K</div>
            <div class="ml-3"><span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">KullanÄ±cÄ±</span></div>
        </div>
    </div>
        <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">
        <a id="link-metin-analiz" href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all">
            <i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i><span>Metin Analiz</span></a>
        
        <a href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
            <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i><span>Soru Ãœretim</span></a>
        
        <a href="/metin-olusturma" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-500 hover:bg-purple-600 transition-all">
            <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i><span>Metin OluÅŸturma</span></a>
        
        <a id="link-haritada-bul" href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all">
            <i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i><span>Haritada Bul</span></a>
        
        <a href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
            <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i><span>Podcast Yap</span></a>
        
        <a id="link-seyret-bul" href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all">
            <i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i><span>Seyret Bul</span></a>
        
        <a href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-600 ring-2 ring-teal-300 transition-all">
            <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i><span>Beceri/DeÄŸer AvcÄ±sÄ±</span></a>
        
        <a id="link-video-istegi" href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
            <i class="fa-solid fa-video mr-3 w-6 text-center"></i><span>Video Ä°steÄŸi</span></a>
    </nav>
    <div class="p-4 border-t border-gray-200">
        <a href="/dashboard" class="flex items-center mx-2 p-2 rounded-lg text-gray-600 font-semibold bg-gray-100 hover:bg-gray-200 transition-all"><i class="fa-solid fa-arrow-left mr-3 w-6 text-center"></i><span>Panele Geri DÃ¶n</span></a>
    </div>
    </aside>
    
    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">TakÄ±m YarÄ±ÅŸmasÄ± Kurulumu</h2>
        
        <div id="loading-message" class="hidden bg-yellow-100 p-4 rounded-lg shadow text-yellow-800 font-semibold">Ã–ÄŸrenci verileri yÃ¼kleniyor...</div>
        <div id="error-message" class="hidden bg-red-100 p-4 rounded-lg shadow text-red-800 font-semibold"></div>

        <div id="step-1" class="bg-white p-6 rounded-lg shadow mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2 p-2 rounded-lg bg-blue-50 border border-blue-200">
                <h4 class="font-bold text-blue-800 mb-1">Sorumlu SÄ±nÄ±f</h4>
                <p id="teacher-class-info" class="text-lg font-semibold text-gray-800">YÃ¼kleniyor...</p>
                <input type="hidden" id="okul-select" value="">
                <input type="hidden" id="sinif-select" value="">
            </div>
            
            <div>
                <label for="takim-sayisi-select" class="block text-sm font-medium text-gray-700 mb-1">1. TakÄ±m SayÄ±sÄ±</label>
                <select id="takim-sayisi-select" class="w-full px-4 py-2 border rounded-lg bg-white" disabled>
                    <option value="">SÄ±nÄ±f YÃ¼kleniyor...</option>
                </select>
            </div>
            
            <div>
                <label for="kisi-sayisi-select" class="block text-sm font-medium text-gray-700 mb-1">2. TakÄ±m BaÅŸÄ± KiÅŸi</label>
                <select id="kisi-sayisi-select" class="w-full px-4 py-2 border rounded-lg bg-white" disabled>
                    <option value="">SÄ±nÄ±f YÃ¼kleniyor...</option>
                </select>
            </div>   
            <div class="col-span-4 text-center">
                <button id="sinif-listesini-getir-btn" class="mt-4 bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-all" disabled>
                    TakÄ±mlarÄ± Ã–nizle
                </button>
            </div>
        </div>
           
        <div id="step-2" class="hidden mt-6 bg-white p-6 rounded-lg shadow">
            
            <div class="grid grid-cols-1 md:grid-cols-10 gap-6 w-full"> 
                
                <div class="md:col-span-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow min-h-[400px]">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800">Ã–ÄŸrenci Listesi (<span id="unassigned-count">0</span> KiÅŸi)</h3>
                            <button id="select-all-btn" class="text-xs text-blue-500 hover:underline">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                        </div>
                        <div id="student-list-container" class="space-y-1 max-h-96 overflow-y-auto">
                            </div>
                        <button id="otomatik-eslestir-btn" class="mt-4 w-full bg-orange-500 text-white font-bold py-2 rounded-lg hover:bg-orange-600 transition-all">
                            Otomatik TakÄ±m OluÅŸtur
                        </button>
                    </div>
                </div>
                
                <div class="md:col-span-2 flex flex-col items-center justify-center pt-8">
                    </div>

                <div id="team-assignment-container" class="md:col-span-4 grid grid-cols-2 gap-4 max-h-[500px] overflow-y-auto">
                     </div>
                
            </div>
            
            <div class="pt-4 border-t mt-6 text-center">
                <button id="yarismayi-baslat-btn" class="bg-green-500 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-lg hover:bg-green-600 transition-all disabled:opacity-50" disabled>
                    YarÄ±ÅŸmayÄ± BaÅŸlat
                </button>
                <div id="takim-baslatma-mesaj" class="mt-4 text-red-500 font-semibold text-center hidden"></div>
            </div>
            
        </div>
        <div id="game-screen" class="hidden mt-6">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">YarÄ±ÅŸma BaÅŸladÄ±!</h2>
            <p class="text-gray-600">Oyun arayÃ¼zÃ¼ bir sonraki adÄ±mda buraya gelecek...</p>
        </div>
        
    </main>
    <script>
        // --- Sabit Veri ---
        const SCHOOLS = [{name: "Sezi Eratik Ortaokulu"}, {name: "TOKÄ° Demokrasi Ortaokulu"}];
        const CLASSES = ["5A", "5B", "5C", "5D", "5E", "5F"];
        
        // --- Global State ---
        let currentStudentList = [];
        let teams = [];
        let teamCount = 0;
        let studentsPerTeam = 0;

        // --- DOM Elements ---
        const okulSelect = document.getElementById('okul-select');
        const sinifSelect = document.getElementById('sinif-select');
        const takimSayisiSelect = document.getElementById('takim-sayisi-select');
        const kisiSayisiSelect = document.getElementById('kisi-sayisi-select');
        const listeyiGetirBtn = document.getElementById('sinif-listesini-getir-btn');
        const loadingMessage = document.getElementById('loading-message');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const studentListContainer = document.getElementById('student-list-container');
        const unassignedCountSpan = document.getElementById('unassigned-count');
        const teamAssignmentContainer = document.getElementById('team-assignment-container');
        const otomatikEslestirBtn = document.getElementById('otomatik-eslestir-btn');
        const yarismayiBaslatBtn = document.getElementById('yarismayi-baslat-btn');
        const takimBaslatmaMesaj = document.getElementById('takim-baslatma-mesaj');
        const errorMessage = document.getElementById('error-message');


        // ########## GEREKLÄ° TEMEL FONKSÄ°YONLAR ##########

        function initializeSelections() {
            // (Bu fonksiyon Ã¶ÄŸretmen giriÅŸinde kullanÄ±lmÄ±yor, yedek)
            okulSelect.innerHTML = '<option value="">Okul SeÃ§in...</option>';
            SCHOOLS.forEach(s => {
                okulSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            });

            sinifSelect.innerHTML = '<option value="">SÄ±nÄ±f SeÃ§in...</option>';
            CLASSES.forEach(c => {
                sinifSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            sinifSelect.disabled = true;
        }
        
        function updateTeamSettings() {
            const totalStudents = currentStudentList.length;
            if (totalStudents < 2) { // En az 2 Ã¶ÄŸrenci lazÄ±m (1 vs 1 iÃ§in)
                errorMessage.textContent = "Bu sÄ±nÄ±fta takÄ±m oluÅŸturmak iÃ§in yeterli Ã¶ÄŸrenci yok.";
                errorMessage.style.display = 'block';
                return;
            }
            
            takimSayisiSelect.innerHTML = '<option value="">TakÄ±m SayÄ±sÄ±</option>';
            kisiSayisiSelect.innerHTML = '<option value="">KiÅŸi SayÄ±sÄ±</option>';

            // 1. TakÄ±m SayÄ±sÄ± DÃ¶ngÃ¼sÃ¼ (En az 2 takÄ±m olmalÄ±)
            const maxTeams = 4; 
            for (let i = 2; i <= maxTeams; i++) {
                if (totalStudents >= i) { // Toplam Ã¶ÄŸrenci sayÄ±sÄ± takÄ±m sayÄ±sÄ±na yetiyor mu?
                    takimSayisiSelect.innerHTML += `<option value="${i}">${i}</option>`;
                }
            }

            // 2. KiÅŸi SayÄ±sÄ± DÃ¶ngÃ¼sÃ¼ (GÃœNCELLENDÄ°: 1'den baÅŸlÄ±yor)
            const maxStudentsPerTeam = 5; 
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ BURASI ARTIK 1'DEN BAÅLIYOR ğŸ‘‡ğŸ‘‡ğŸ‘‡
            for (let i = 1; i <= maxStudentsPerTeam; i++) {
                // En az 2 takÄ±m kurulacaÄŸÄ± iÃ§in (i * 2) kadar Ã¶ÄŸrenci var mÄ± diye bakÄ±yoruz
                if (totalStudents >= (i * 2)) {
                    kisiSayisiSelect.innerHTML += `<option value="${i}">${i}</option>`;
                }
            }
            // ğŸ‘†ğŸ‘†ğŸ‘† DEÄÄ°ÅÄ°KLÄ°K BURADA ğŸ‘†ğŸ‘†ğŸ‘†

            takimSayisiSelect.disabled = false;
            kisiSayisiSelect.disabled = false;
            listeyiGetirBtn.disabled = true; 

            takimSayisiSelect.value = ""; 
            kisiSayisiSelect.value = ""; 
            
            takimSayisiSelect.addEventListener('change', checkStep1Readiness);
            kisiSayisiSelect.addEventListener('change', checkStep1Readiness);
            
            checkStep1Readiness();
        }
        
        function checkStep1Readiness() {
            const takimSayisi = takimSayisiSelect.value;
            const kisiSayisi = kisiSayisiSelect.value;
            
            if (takimSayisi && kisiSayisi) {
                teamCount = parseInt(takimSayisi);
                studentsPerTeam = parseInt(kisiSayisi);
                createEmptyTeams(teamCount);
                step2.classList.remove('hidden');
                renderStudentList();
                renderTeamBoxes();
            } else {
                step2.classList.add('hidden');
            }
        }

        // ########## Ã–ÄRENCÄ° LÄ°STESÄ° VE TAKIM ATAMA EKRANI ##########
        
        function renderStudentList() {
            studentListContainer.innerHTML = '';
            let unassignedCount = 0;
            
            currentStudentList.forEach((student, index) => {
                const isAssigned = teams.some(team => team.uyeler.some(u => u.no === student.no));
                if (!isAssigned) unassignedCount++;
                
                const item = document.createElement('div');
                item.className = `student-item ${isAssigned ? 'assigned' : ''} ${student.selected ? 'selected' : ''}`;
                item.dataset.no = student.no;
                item.dataset.index = index;
                // --- YENÄ°: Ã‡evrimiÃ§i Durumu GÃ¶stergesi ---
                let onlineBadge = '';
                if (student.is_online) {
                    onlineBadge = ' <span class="text-green-600 font-bold text-xs animate-pulse">â— Ã‡evrimiÃ§i</span>';
                }
                item.innerHTML = student.ad_soyad + onlineBadge;
                
                if (!isAssigned) {
                    item.onclick = () => toggleStudentSelection(index);
                }
                studentListContainer.appendChild(item);
            });
            
            unassignedCountSpan.textContent = unassignedCount;
            checkTeamCreationReadiness();
        }

        function toggleStudentSelection(index) {
            currentStudentList[index].selected = !currentStudentList[index].selected;
            renderStudentList();
        }

        function renderTeamBoxes() {
            teamAssignmentContainer.innerHTML = '';
            teams.forEach((team, teamIndex) => {
                const box = document.createElement('div');
                box.className = 'bg-gray-50 p-3 rounded-lg shadow-inner';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-2';
                header.innerHTML = `<h4 contenteditable="true" data-index="${teamIndex}" class="font-bold text-teal-700">${team.ad}</h4>
                                    <button onclick="removeTeam(${teamIndex})" class="text-red-500 text-xs font-semibold">[Sil]</button>`;
                box.appendChild(header);
                
                const ul = document.createElement('ul');
                ul.id = `team-${teamIndex}-list`;
                team.uyeler.forEach(uye => {
                    ul.innerHTML += `<li class="team-list-item">${uye.ad_soyad} <button onclick="removeStudentFromTeam(${teamIndex}, '${uye.no}')" class="text-red-700 text-xs ml-1 font-semibold">[x]</button></li>`;
                });
                box.appendChild(ul);
                
                // DÃœZELTME: Atama butonu, sadece takÄ±m dolu deÄŸilse gÃ¶rÃ¼nÃ¼r
                const assignBtn = document.createElement('button');
                const isFull = (studentsPerTeam > 0 && team.uyeler.length >= studentsPerTeam);
                
                assignBtn.className = `w-full mt-2 text-white text-sm py-1 rounded ${isFull ? 'bg-gray-400' : 'bg-blue-500 hover:bg-blue-600'}`;
                assignBtn.textContent = isFull ? 'TakÄ±m Dolu' : 'SeÃ§ilenleri Ata';
                assignBtn.disabled = isFull;
                
                assignBtn.onclick = () => assignSelectedStudentsToTeam(teamIndex);
                box.appendChild(assignBtn);
                
                box.querySelector('h4').addEventListener('blur', (e) => {
                    teams[teamIndex].ad = e.target.textContent.trim();
                });

                teamAssignmentContainer.appendChild(box);
            });
            checkTeamCreationReadiness();
        }

        function createEmptyTeams(count) {
            teams = [];
            for (let i = 1; i <= count; i++) {
                teams.push({ ad: `TakÄ±m ${i}`, uyeler: [] });
            }
        }
        
        // DÃœZELTME: TakÄ±m limitini (studentsPerTeam) kontrol eder
        function assignSelectedStudentsToTeam(teamIndex) {
            const team = teams[teamIndex];
            const unassignedSelected = currentStudentList.filter(s => s.selected && !teams.some(t => t.uyeler.some(u => u.no === s.no)));
            
            if (unassignedSelected.length === 0) {
                alert("Ã–nce Ã¶ÄŸrencileri soldan seÃ§in.");
                return;
            }

            // DÃœZELTME (Kural 2 - Doluluk): TakÄ±m kapasitesini kontrol et
            if (studentsPerTeam > 0 && (team.uyeler.length + unassignedSelected.length) > studentsPerTeam) {
                alert(`Hata: Bu takÄ±ma en fazla ${studentsPerTeam} kiÅŸi ekleyebilirsiniz. TakÄ±mda ${team.uyeler.length} kiÅŸi var, ${unassignedSelected.length} kiÅŸi daha eklenemez.`);
                return;
            }
            
            unassignedSelected.forEach(student => {
                // Sadece limit dahilindekileri ekle (Bu bir Ã§ift kontrol)
                if (team.uyeler.length < studentsPerTeam) {
                    team.uyeler.push({ no: student.no, ad_soyad: student.ad_soyad });
                    student.selected = false; // SeÃ§imi kaldÄ±r
                }
            });
            
            renderTeamBoxes();
            renderStudentList();
        }
        
        function removeStudentFromTeam(teamIndex, studentNo) {
            const team = teams[teamIndex];
            team.uyeler = team.uyeler.filter(u => u.no !== studentNo);
            
            const studentInList = currentStudentList.find(s => s.no === studentNo);
            if (studentInList) studentInList.selected = false;
            
            renderTeamBoxes();
            renderStudentList();
        }
        
        function removeTeam(teamIndex) {
            if (confirm(`'${teams[teamIndex].ad}' takÄ±mÄ±nÄ± silmek istediÄŸinizden emin misiniz? TakÄ±mdaki Ã¶ÄŸrenciler listeye geri dÃ¶necektir.`)) {
                teams[teamIndex].uyeler.forEach(uye => {
                    const studentInList = currentStudentList.find(s => s.no === uye.no);
                    if (studentInList) studentInList.selected = false; 
                });
                teams.splice(teamIndex, 1);
                renderTeamBoxes();
                renderStudentList();
            }
        }
        
        function checkTeamCreationReadiness() {
            otomatikEslestirBtn.disabled = !(currentStudentList.length >= (teamCount * studentsPerTeam) && teamCount > 0 && studentsPerTeam > 0);
            yarismayiBaslatBtn.disabled = !checkAllTeamsFull();
        }
        
        // DÃœZELTME: 'YarÄ±ÅŸmayÄ± BaÅŸlat' butonunu aktifleÅŸtirme mantÄ±ÄŸÄ±
        function checkAllTeamsFull() {
            if (teams.length === 0) return false;
            
            // 1. TakÄ±m sayÄ±sÄ±, seÃ§ilen takÄ±m sayÄ±sÄ±yla eÅŸleÅŸmeli
            if (teams.length !== teamCount) {
                takimBaslatmaMesaj.textContent = `Hata: ${teamCount} takÄ±m olmalÄ±, ÅŸu an ${teams.length} takÄ±m var.`;
                takimBaslatmaMesaj.classList.remove('hidden');
                return false;
            }
            
            // 2. HER takÄ±mÄ±n kiÅŸi sayÄ±sÄ± TAM OLARAK `studentsPerTeam` olmalÄ±
            const allTeamsFull = teams.every(team => team.uyeler.length === studentsPerTeam);
            
            if (!allTeamsFull) {
                takimBaslatmaMesaj.textContent = `Devam etmek iÃ§in ${teamCount} takÄ±mÄ±n her birinde tam ${studentsPerTeam} Ã¶ÄŸrenci olmalÄ±dÄ±r.`;
                takimBaslatmaMesaj.classList.remove('hidden');
                return false;
            }

            takimBaslatmaMesaj.classList.add('hidden');
            return true; // TÃ¼m koÅŸullar saÄŸlandÄ±
        }

        // ########## OLAY DÄ°NLEYÄ°CÄ°LERÄ° ##########

        // ########## BAÅLANGIÃ‡ ##########
        
        document.addEventListener('DOMContentLoaded', async () => {
            const userFullName = localStorage.getItem('loggedInUserName'); 
            const userRole = localStorage.getItem('loggedInUserRole');
            const teacherClass = localStorage.getItem('loggedInUserClass'); 
            const teacherSchool = localStorage.getItem('loggedInUserSchool'); 
            
            // 1. KullanÄ±cÄ± adÄ±nÄ± yÃ¼kle
            if (userFullName) {
                document.getElementById('user-name-placeholder').textContent = userFullName;
                document.getElementById('user-avatar-initial').textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
            }
            // 2. Rol KontrolÃ¼ (Sol MenÃ¼)
            if (userRole === 'teacher') {
                const linkMetinAnaliz = document.getElementById('link-metin-analiz');
                const linkSeyretBul = document.getElementById('link-seyret-bul');
                const linkHaritadaBul = document.getElementById('link-haritada-bul');
                if (linkMetinAnaliz) linkMetinAnaliz.style.display = 'none';
                if (linkSeyretBul) linkSeyretBul.style.display = 'none';
                if (linkHaritadaBul) linkHaritadaBul.style.display = 'none';
            }
            
            if (userRole !== 'teacher') {
                errorMessage.textContent = "Bu panel sadece Ã¶ÄŸretmenler iÃ§indir.";
                errorMessage.style.display = 'block';
                return;
            }

            if (!teacherClass || !teacherSchool) {
                errorMessage.textContent = "Hata: Ã–ÄŸretmen kaydÄ±nÄ±zda okul veya sÄ±nÄ±f bilgisi eksik.";
                errorMessage.style.display = 'block';
                return;
            }

            // 3. Bilgi Panelini Doldur
            document.getElementById('teacher-class-info').textContent = `${teacherSchool} - ${teacherClass}`;
            document.getElementById('okul-select').value = teacherSchool; // Gizli inputlarÄ± doldur
            document.getElementById('sinif-select').value = teacherClass; // Gizli inputlarÄ± doldur
            
            // 4. SÄ±nÄ±f listesini API'den Ã§ek
            try {
                const response = await fetch('/get_all_users');
                const data = await response.json();
                if (data.success) {
                    currentStudentList = Object.entries(data.users)
                        .filter(([id, user]) => 
                            user.role === 'student' && 
                            user.school_name === teacherSchool && 
                            user.class === teacherClass
                        )
                        .map(([id, user]) => ({
                            no: id,
                            ad_soyad: `${user.first_name} ${user.last_name}`,
                            
                            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ BU SATIRI EKLEMELÄ°SÄ°NÄ°Z ğŸ‘‡ğŸ‘‡ğŸ‘‡
                            is_online: user.is_online, 
                            // ğŸ‘†ğŸ‘†ğŸ‘† BURASI EKSÄ°KTÄ° ğŸ‘†ğŸ‘†ğŸ‘†
                            
                            selected: false
                        }));
                    
                    console.log(`âœ… ${currentStudentList.length} Ã¶ÄŸrenci yÃ¼klendi.`);
                    // 5. TakÄ±m AyarlarÄ±nÄ± AktifleÅŸtir
                    updateTeamSettings(); 
                }
            } catch (error) {
                console.error('Ã–ÄŸrenci listesi yÃ¼klenemedi:', error);
                errorMessage.textContent = 'Ã–ÄŸrenci listesi yÃ¼klenemedi.';
                errorMessage.style.display = 'block';
            }

            // 6. TakÄ±mlarÄ± Ã–nizle butonu (DÃœZELTME: MantÄ±k deÄŸiÅŸti)
            listeyiGetirBtn.addEventListener('click', () => {
                const takimSayisi = parseInt(takimSayisiSelect.value);
                const kisiSayisi = parseInt(kisiSayisiSelect.value);
                
                // YENÄ° KURAL: Her iki deÄŸer de seÃ§ilmelidir.
                if (!takimSayisi || !kisiSayisi) {
                    alert("LÃ¼tfen hem TakÄ±m SayÄ±sÄ±nÄ± hem de KiÅŸi SayÄ±sÄ±nÄ± seÃ§in.");
                    return;
                }
                
                // YENÄ° KURAL: Toplam Ã¶ÄŸrenci yetiyor mu?
                if (takimSayisi * kisiSayisi > currentStudentList.length) {
                    alert(`Hata: ${takimSayisi} takÄ±m ve ${kisiSayisi} kiÅŸi (${takimSayisi * kisiSayisi} toplam) iÃ§in yeterli Ã¶ÄŸrenci (${currentStudentList.length}) yok.`);
                    return;
                }

                // DeÄŸiÅŸkenleri global'e ata
                teamCount = takimSayisi;
                studentsPerTeam = kisiSayisi; // <-- HESAPLAMA KALDIRILDI

                createEmptyTeams(teamCount); // BoÅŸ takÄ±mlarÄ± oluÅŸtur
                
                // Step 2'yi gÃ¶ster
                step1.style.display = 'none'; // AdÄ±m 1'i gizle
                step2.style.display = 'block'; // AdÄ±m 2'yi gÃ¶ster
                renderStudentList();
                renderTeamBoxes();
            });

            // "TÃ¼mÃ¼nÃ¼ SeÃ§" butonu
            const selectAllBtn = document.getElementById('select-all-btn');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => {
                    currentStudentList.forEach(s => {
                        if (!teams.some(t => t.uyeler.some(u => u.no === s.no))) {
                            s.selected = true;
                        }
                    });
                    renderStudentList();
                });
            }

            // "Otomatik TakÄ±m OluÅŸtur" butonu (SADECE Ã‡EVRÄ°MÄ°Ã‡Ä°LER)
            if (otomatikEslestirBtn) {
                otomatikEslestirBtn.addEventListener('click', () => {
                    
                    // 1. Mevcut takÄ±mlarÄ± temizle
                    teams.forEach(team => team.uyeler = []);
                    
                    // 2. SADECE Ã‡EVRÄ°MÄ°Ã‡Ä° Ã–ÄRENCÄ°LERÄ° AL (DÃœZELTME BURADA)
                    // (Eski kodda offline olanlarÄ± da ekliyorduk, ÅŸimdi kaldÄ±rdÄ±k)
                    const onlineStudents = currentStudentList.filter(s => s.is_online);

                    // 3. Listeyi karÄ±ÅŸtÄ±r (Rastgelelik iÃ§in)
                    onlineStudents.sort(() => Math.random() - 0.5);

                    // 4. Yeterli sayÄ± var mÄ± kontrol et
                    const requiredStudents = teamCount * studentsPerTeam;
                    
                    if (onlineStudents.length < requiredStudents) {
                        alert(`Hata: Yeterli Ã‡EVRÄ°MÄ°Ã‡Ä° Ã¶ÄŸrenci yok!\n\nÄ°stenen: ${requiredStudents} kiÅŸi\nÃ‡evrimiÃ§i: ${onlineStudents.length} kiÅŸi\n\nLÃ¼tfen Ã¶ÄŸrencilerin sisteme girmesini bekleyin.`);
                        return;
                    }
                    
                    // 5. SÄ±rayla daÄŸÄ±t
                    let studentIndex = 0;
                    for (let t = 0; t < teamCount; t++) { 
                        for (let p = 0; p < studentsPerTeam; p++) { 
                            const student = onlineStudents[studentIndex];
                            teams[t].uyeler.push({ no: student.no, ad_soyad: student.ad_soyad });
                            student.selected = false; 
                            studentIndex++;
                        }
                    }
                    
                    renderTeamBoxes();
                    renderStudentList();
                });
            }
            
            // YarÄ±ÅŸmayÄ± BaÅŸlat butonu (API Ã‡aÄŸrÄ±sÄ±)
            if (yarismayiBaslatBtn) {
                yarismayiBaslatBtn.addEventListener('click', async () => {
                    // checkAllTeamsFull() zaten butonu etkinleÅŸtirdi, tekrar kontrol et
                    if (!checkAllTeamsFull()) {
                        takimBaslatmaMesaj.textContent = 'TÃ¼m takÄ±mlar kurallara gÃ¶re doldurulmalÄ±dÄ±r.';
                        takimBaslatmaMesaj.classList.remove('hidden');
                        return;
                    }

                    yarismayiBaslatBtn.disabled = true;
                    takimBaslatmaMesaj.textContent = 'YarÄ±ÅŸma sunucuda oluÅŸturuluyor...';
                    takimBaslatmaMesaj.classList.remove('hidden', 'text-red-500');
                    takimBaslatmaMesaj.classList.add('text-blue-500');

                    const takimlarListesi = teams.map(team => ({
                        ad: team.ad,
                        uyeler: team.uyeler 
                    }));
                    
                    const okulAdi = document.getElementById('okul-select').value;
                    const sinifAdi = document.getElementById('sinif-select').value;

                    try {
                        const response = await fetch('/api/takim/basla', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                takimlarListesi: takimlarListesi,
                                okul: okulAdi,
                                sinif: sinifAdi
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            takimBaslatmaMesaj.textContent = `YarÄ±ÅŸma baÅŸarÄ±yla oluÅŸturuldu! ID: ${result.yarisma_id}`;
                            takimBaslatmaMesaj.classList.add('text-green-500');
                            
                            setTimeout(() => {
                                window.location.href = `/takim-oyun-ekrani/${result.yarisma_id}`;
                            }, 1000); 

                        } else {
                            takimBaslatmaMesaj.textContent = `Hata: ${result.hata}`;
                            takimBaslatmaMesaj.classList.add('text-red-500');
                            yarismayiBaslatBtn.disabled = false;
                        }
                    } catch (error) {
                        takimBaslatmaMesaj.textContent = `Sunucu hatasÄ±: ${error.message}`;
                        takimBaslatmaMesaj.classList.add('text-red-500');
                        yarismayiBaslatBtn.disabled = false;
                    }
                });
            }
            
           });
</script>
</body>
</html>
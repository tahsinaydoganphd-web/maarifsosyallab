<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Seyret Bul - Video İzle</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        #videoContainer { max-width: 800px; margin: 0 auto; }
        #soruModal { display: none; position: fixed; top: 50%; left: 50%; 
                     transform: translate(-50%, -50%); background: white; 
                     padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); 
                     z-index: 1000; min-width: 400px; }
        .cevap-btn { display: block; margin: 10px 0; padding: 10px; 
                     background: #007bff; color: white; border: none; 
                     border-radius: 5px; cursor: pointer; width: 100%; }
        .cevap-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div id="videoContainer">
        <h2 id="videoBaslik">Yükleniyor...</h2>
        <div id="player"></div>
    </div>
    
    <div id="soruModal">
        <h3 id="soruMetni"></h3>
        <div id="cevaplar"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const VIDEO_ID = "{{ video_id }}";
        let player, videoData, sorular, currentSoruIndex = 0;

        fetch(`/api/seyret-bul/video-detay/${VIDEO_ID}`)
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    videoData = data.video;
                    document.getElementById('videoBaslik').textContent = videoData.baslik;
                    sorular = videoData.sorular.slice(0, 3);
                    sorular.sort((a,b) => a.duraklatma_saniyesi - b.duraklatma_saniyesi);
                    onYouTubeIframeAPIReady();
                }
            });

        function onYouTubeIframeAPIReady() {
            const ytId = videoData.url.match(/[?&]v=([^&]+)/)[1];
            player = new YT.Player('player', {
                height: '450',
                width: '800',
                videoId: ytId,
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if(event.data == YT.PlayerState.PLAYING && currentSoruIndex < sorular.length) {
                checkTime();
            }
        }

        function checkTime() {
            const interval = setInterval(() => {
                if(currentSoruIndex >= sorular.length || !player) {
                    clearInterval(interval);
                    return;
                }
                // YouTube veya HTML5 için farklı API
                const currentTime = player.getCurrentTime ? player.getCurrentTime() : player.currentTime;
                const soruZamani = sorular[currentSoruIndex].duraklatma_saniyesi;
                
                // Progress bar güncelle
                const progress = (currentTime / videoData.sure_saniye) * 100;
                document.getElementById('progress').style.width = `${progress}%`;
                
                if(currentTime >= soruZamani) {
                    // YouTube veya HTML5 için farklı pause
                    if (player.pauseVideo) {
                        player.pauseVideo();  // YouTube
                    } else {
                        player.pause();  // HTML5
                    }
                    showSoru(sorular[currentSoruIndex]);
                    clearInterval(interval);
                }
            }, 100);
        }

        function showSoru(soru) {
        // Eğer tip yoksa, default olarak çoktan seçmeli kabul et
        if (!soru.tip && soru.cevaplar && Array.isArray(soru.cevaplar)) {
            soru.tip = 'coktan_secmeli';
        }
        
        document.getElementById('soruMetni').textContent = soru.soru;
        const cevaplarDiv = document.getElementById('cevaplar');
        cevaplarDiv.innerHTML = '';
        
        // SORU TİPİNE GÖRE FARKLI UI
    if (soru.tip === 'coktan_secmeli') {
        // Çoktan seçmeli - şıklar
        const harfler = ['A', 'B', 'C', 'D'];
        soru.cevaplar.forEach((cevap, i) => {
        const btn = document.createElement('button');
        btn.className = 'w-full p-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-all';
        btn.textContent = `${harfler[i]}) ${cevap}`;
        btn.onclick = () => checkCevap(harfler[i], soru.dogru_cevap, soru.tip);
        cevaplarDiv.appendChild(btn);
        });
    }
    else if (soru.tip === 'bosluk_doldurma') {
        // Boşluk doldurma - input + buton
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full p-3 border-2 border-gray-300 rounded-lg mb-3';
        input.placeholder = 'Cevabınızı yazın...';
        input.id = 'cevap-input';
        
        const btn = document.createElement('button');
        btn.className = 'w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all';
        btn.textContent = 'Cevabımı Gönder';
        btn.onclick = () => {
            const cevap = document.getElementById('cevap-input').value.trim();
            checkCevap(cevap, soru.dogru_cevap, soru.tip);
        };
        
        cevaplarDiv.appendChild(input);
        cevaplarDiv.appendChild(btn);
    }
    else if (soru.tip === 'kisa_cevap') {
        // Kısa cevap - textarea + buton
        const textarea = document.createElement('textarea');
        textarea.className = 'w-full p-3 border-2 border-gray-300 rounded-lg mb-3';
        textarea.placeholder = '3-4 kelimelik cevabınızı yazın...';
        textarea.rows = 3;
        textarea.id = 'cevap-textarea';
        
        const btn = document.createElement('button');
        btn.className = 'w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all';
        btn.textContent = 'Cevabımı Gönder';
        btn.onclick = () => {
            const cevap = document.getElementById('cevap-textarea').value.trim();
            checkCevapGemini(cevap, soru.soru, soru.tip);
        };
        
        cevaplarDiv.appendChild(textarea);
        cevaplarDiv.appendChild(btn);
    }
    
    document.getElementById('soruModal').classList.remove('hidden');
    }

        function checkCevap(secilen, dogru, tip) {
            let mesaj = '';
            if(secilen === dogru || secilen.toLowerCase() === dogru.toLowerCase()) {
                mesaj = '✅ Tebrikler! Maarif SosyalLab ile Öğreniyorsun';
            } else {
                if(tip === 'bosluk_doldurma') {
                    mesaj = `❌ Üzgünüm. Doğru Cevap: ${dogru}`;
                } else {
                    mesaj = `❌ Yanlış! Doğru cevap: ${dogru}`;
                }
            }
            alert(mesaj);
            document.getElementById('soruModal').classList.add('hidden');
            currentSoruIndex++;
            
            // YouTube veya HTML5 için farklı play
            if (player.playVideo) {
                player.playVideo();
            } else {
                player.play();
            }
            
            if(currentSoruIndex < sorular.length) checkTime();
        }
        
        async function checkCevapGemini(ogrenciCevap, soru, tip) {
            if(!ogrenciCevap) {
                alert('Lütfen bir cevap yazın!');
                return;
            }
            
            try {
                const response = await fetch('/api/seyret-bul/gemini-cevap-kontrol', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        soru: soru,
                        ogrenci_cevap: ogrenciCevap
                    })
                });
                
                const result = await response.json();
                
                if(result.dogru) {
                    alert('✅ Tebrikler! Maarif SosyalLab ile Öğreniyorsun');
                } else {
                    alert(`❌ Üzgünüm. Doğru Cevap: ${result.dogru_cevap || 'Bilinmiyor'}`);
                }
                
                document.getElementById('soruModal').classList.add('hidden');
                currentSoruIndex++;
                if (player.playVideo) player.playVideo(); else player.play();
                if(currentSoruIndex < sorular.length) checkTime();
                
            } catch(e) {
                alert('Cevap kontrol edilemedi!');
            }
        }
        
    </script>
</body>
</html>
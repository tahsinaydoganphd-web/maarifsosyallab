<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Ãœretim AracÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: #10b981; /* green-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            .answer-key {
            color: #2563eb; /* Tailwind blue-600 */
            font-weight: 600; /* KalÄ±n yazÄ± */
        }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">

            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">
                Maarif SosyalLab
            </h1>

            <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png"  
                         alt="Maarif Logo" 
                         class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>

            <div class="flex items-center">
                <div id="user-avatar-initial" class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">K</div>
                <div class="ml-3">
                    <span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">KullanÄ±cÄ±</span>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">

            <a id="link-metin-analiz" href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all">
                <i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i>
                <span>Metin Analiz</span>
            </a>
            <a id="link-soru-uretim" href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-600 ring-2 ring-green-300 transition-all">
                <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i>
                <span>Soru Ãœretim</span>
            </a>
            <a id="link-metin-olusturma" href="/metin-olusturma" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-500 hover:bg-purple-600 transition-all">
                <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i>
                <span>Metin OluÅŸturma</span>
            </a>
            <a id="link-haritada-bul" href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all">
                <i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i>
                <span>Haritada Bul</span>
            </a>
            <a id="link-podcast" href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
                <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i>
                <span>Podcast Yap</span>
            </a>
            <a id="link-seyret-bul" href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all">
                <i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i>
                <span>Seyret Bul</span>
            </a>
            <a id="link-yarisma" href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-500 hover:bg-teal-600 transition-all">
                <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i>
                <span>Beceri/DeÄŸer AvcÄ±sÄ±</span>
            </a>
            <a id="link-video-istegi" href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
                <i class="fa-solid fa-video mr-3 w-6 text-center"></i>
                <span>Video Ä°steÄŸi</span>
            </a>
            
        </nav>

        <div class="p-4 border-t border-gray-200">
            <a href="/dashboard" class="flex items-center mx-2 p-2 rounded-lg text-gray-600 font-semibold bg-gray-100 hover:bg-gray-200 transition-all">
                <i class="fa-solid fa-arrow-left mr-3 w-6 text-center"></i>
                <span>Panele Geri DÃ¶n</span>
            </a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Soru Ãœretim AracÄ±</h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
                <form id="soru-form">

                    <div class="mb-4">
                        <label for="bilesen-kodu" class="block text-sm font-medium text-gray-700 mb-1">SÃ¼reÃ§ BileÅŸeni</label>
                        <select id="bilesen-kodu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" required>
                            <option value="">LÃ¼tfen bir sÃ¼reÃ§ bileÅŸeni seÃ§in...</option>
                            </select>
                    </div>

                    <div class="mb-4">
                        <label for="soru-tipi" class="block text-sm font-medium text-gray-700 mb-1">Soru Tipi</label>
                        <select id="soru-tipi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" required disabled>
                            <option value="">Ã–nce SÃ¼reÃ§ BileÅŸeni SeÃ§in...</option>
                            </select>
                    </div>

                    <button type="submit" id="generate-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg hover:bg-green-600 transition-all duration-300 flex items-center justify-center">
                        <i class="fa-solid fa-circle-question mr-2"></i>
                        <span>Soru Ãœret</span>
                    </button>
                    <div id="loading-spinner" class="hidden flex items-center justify-center w-full bg-green-300 text-green-800 font-bold py-3 px-6 rounded-lg text-lg">
                        <div class="spinner mr-3"></div>
                        <span>Ãœretiliyor...</span>
                    </div>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Ãœretilen Soru</h3>
                    <div class="flex space-x-2">
                        <button id="copy-btn" title="Soruyu kopyala" class="text-gray-500 hover:text-blue-600"><i class="fa-solid fa-copy"></i></button>
                    </div>
                </div>

                <div id="result-message" class="mb-4"></div>

                <textarea id="result-text" readonly class="w-full h-96 p-4 border border-gray-200 rounded-lg bg-gray-50 overflow-y-auto text-gray-700" placeholder="Soru Ã¼retmek iÃ§in lÃ¼tfen soldaki formu doldurun..."></textarea>
                
                <div class="mt-4 border-t pt-4">
                    <button id="show-answer-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all" disabled>
                        CevabÄ± GÃ¶ster (Puanlama AnahtarÄ±)
                    </button>
                    <div id="rubrik-container" class="mt-3 p-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-800 font-medium hidden">
                        <h4 class="font-bold mb-2">ðŸ’Ž Puanlama AnahtarÄ± (10 Puan Ãœzerinden)</h4>
                        <p id="rubrik-content" style="white-space: pre-wrap;"></p>
                    </div>
                </div>
                </div>

    <script>
        // Python'dan gelen ana veri yapÄ±sÄ± (soru_uretim.SORU_SABLONLARI)
        const soruSablonlari = {{ soru_sablonlari | tojson }};

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elementleri ---
            const bilesenSelect = document.getElementById('bilesen-kodu');
            const soruTipiSelect = document.getElementById('soru-tipi');
            const soruForm = document.getElementById('soru-form');
            const generateBtn = document.getElementById('generate-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultText = document.getElementById('result-text');
            const resultMessage = document.getElementById('result-message');
            const copyBtn = document.getElementById('copy-btn');
            
            // --- Rubrik (Cevap AnahtarÄ±) iÃ§in YENÄ° elementler ---
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const rubrikContainer = document.getElementById('rubrik-container');
            const rubrikContent = document.getElementById('rubrik-content');
            let currentRubrik = ''; // API'den gelen rubriÄŸi saklamak iÃ§in

            // --- KullanÄ±cÄ± AdÄ± ve Rol YÃ¼kleme ---
            const userFullName = localStorage.getItem('loggedInUserName');
            const studentNo = localStorage.getItem('loggedInUserNo'); // Limit iÃ§in
            const userRole = localStorage.getItem('loggedInUserRole'); 

            if (userFullName) {
                document.getElementById('user-name-placeholder').textContent = userFullName;
                document.getElementById('user-avatar-initial').textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
            }
            
            // --- Yan MenÃ¼ Rol KontrolÃ¼ ---
            const linkMetinAnaliz = document.getElementById('link-metin-analiz');
            const linkSoruUretim = document.getElementById('link-soru-uretim');
            const linkMetinOlusturma = document.getElementById('link-metin-olusturma');
            const linkHaritadaBul = document.getElementById('link-haritada-bul');
            const linkPodcast = document.getElementById('link-podcast');
            const linkSeyretBul = document.getElementById('link-seyret-bul');
            const linkYarisma = document.getElementById('link-yarisma');
            const linkVideoIstegi = document.getElementById('link-video-istegi');

            if (userRole === 'teacher') {
                if (linkMetinAnaliz) linkMetinAnaliz.style.display = 'none';
                if (linkSeyretBul) linkSeyretBul.style.display = 'none';
                if (linkHaritadaBul) linkHaritadaBul.style.display = 'none'; 
            } else {
                if (linkMetinOlusturma) linkMetinOlusturma.style.display = 'none';
            }
            // --- Rol KontrolÃ¼ Bitti ---

            // 1. SÃ¼reÃ§ BileÅŸeni MenÃ¼sÃ¼nÃ¼ Doldur (ArtÄ±k Ã§alÄ±ÅŸacak)
            for (const kod in soruSablonlari) {
                const data = soruSablonlari[kod];
                const option = document.createElement('option');
                option.value = kod;
                const kisaAciklama = data.aciklama.substring(0, 60) + '...';
                option.textContent = `${kod} - ${kisaAciklama}`;
                option.title = data.aciklama; 
                bilesenSelect.appendChild(option);
            }

            // 2. SÃ¼reÃ§ BileÅŸeni deÄŸiÅŸtiÄŸinde Soru Tipi menÃ¼sÃ¼nÃ¼ gÃ¼ncelle (ArtÄ±k Ã§alÄ±ÅŸacak)
            bilesenSelect.addEventListener('change', () => {
                const selectedBilesenKodu = bilesenSelect.value;
                soruTipiSelect.innerHTML = '<option value="">LÃ¼tfen bir soru tipi seÃ§in...</option>';

                if (selectedBilesenKodu && soruSablonlari[selectedBilesenKodu]) {
                    const soruTipleri = soruSablonlari[selectedBilesenKodu].soru_tipleri;
                    for (const tipAdi in soruTipleri) {
                        const option = document.createElement('option');
                        option.value = tipAdi;
                        option.textContent = tipAdi;
                        soruTipiSelect.appendChild(option);
                    }
                    
                    const ayirici = document.createElement('option');
                    ayirici.disabled = true;
                    ayirici.textContent = '--- Genel Tipler ---';
                    soruTipiSelect.appendChild(ayirici);

                    const optionMC = document.createElement('option');
                    optionMC.value = "GENEL_COKTAN_SECME"; 
                    optionMC.textContent = "(Genel) Ã‡oktan SeÃ§meli Soru";
                    soruTipiSelect.appendChild(optionMC);

                    const optionMetin = document.createElement('option');
                    optionMetin.value = "GENEL_METIN_YORUM";
                    optionMetin.textContent = "(Genel) Metne DayalÄ± Yorum Sorusu";
                    soruTipiSelect.appendChild(optionMetin);

                    soruTipiSelect.disabled = false;
                } else {
                    soruTipiSelect.disabled = true;
                    soruTipiSelect.innerHTML = '<option value="">Ã–nce SÃ¼reÃ§ BileÅŸeni SeÃ§in...</option>';
                }
            });
           
            // 3. Form GÃ¶nderme (YENÄ° - Rubrik destekli)
            soruForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const bilesenKodu = bilesenSelect.value;
                const soruTipiAdi = soruTipiSelect.value;
                
                if (!studentNo) {
                    resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Hata: KullanÄ±cÄ± ID'si bulunamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.</div>`;
                    return;
                }

                generateBtn.style.display = 'none';
                loadingSpinner.style.display = 'flex';
                resultText.value = 'Sorunuz Ã¼retiliyor, bu iÅŸlem biraz zaman alabilir...'; 
                resultMessage.innerHTML = '';
                rubrikContainer.classList.add('hidden'); // RubriÄŸi gizle
                showAnswerBtn.disabled = true; // Butonu kilitle

                try {
                    const response = await fetch('/api/generate-question', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bilesen_kodu: bilesenKodu,
                            soru_tipi_adi: soruTipiAdi,
                            student_no: studentNo 
                        })
                    });
                    const result = await response.json();

                    // --- BU BLOK TAMAMEN YENÄ°LENDÄ° ---
                    if (result.success) {
                        resultText.value = result.metin; // Sadece soruyu gÃ¶ster
                        currentRubrik = result.rubrik_cevap; // RubriÄŸi hafÄ±zaya al
                        rubrikContainer.classList.add('hidden'); // RubriÄŸi gizle

                        if (result.is_mcq) {
                            // Soru Ã§oktan seÃ§meliyse, cevap zaten metnin iÃ§inde.
                            showAnswerBtn.disabled = true;
                            showAnswerBtn.textContent = "Cevap metne dahildir";
                        } else {
                            // Soru aÃ§Ä±k uÃ§luysa, rubrik butonunu aÃ§
                            showAnswerBtn.disabled = false;
                            showAnswerBtn.textContent = "CevabÄ± GÃ¶ster (Puanlama AnahtarÄ±)";
                        }
                        
                        resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-green-100 text-green-800 text-sm">Soru baÅŸarÄ±yla Ã¼retildi. (Limitiniz gÃ¼ncellendi)</div>`;
                    
                    } else {
                        resultText.value = 'Soru Ã¼retilemedi.';
                        currentRubrik = '';
                        rubrikContainer.classList.add('hidden');
                        showAnswerBtn.disabled = true;
                        showAnswerBtn.textContent = "CevabÄ± GÃ¶ster (Puanlama AnahtarÄ±)";
                        resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Hata: ${result.metin}</div>`;
                    }
                    // --- YENÄ° BLOK BÄ°TTÄ° ---

                } catch (error) {
                    console.error("Soru Ã¼retme hatasÄ±:", error);
                    resultText.value = 'Soru Ã¼retilemedi.';
                    resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Sunucuyla iletiÅŸim kurulamadÄ±: Failed to fetch. API anahtarÄ±nÄ±zÄ± kontrol edin.</div>`;
                } finally {
                    generateBtn.style.display = 'flex';
                    loadingSpinner.style.display = 'none';
                }
            });
            
            // 4. Kopyala Butonu
            copyBtn.addEventListener('click', () => {
                resultText.select(); 
                try {
                    document.execCommand('copy'); 
                    resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-blue-100 text-blue-800 text-sm">Soru panoya kopyalandÄ±!</div>`;
                } catch (err) {
                    resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Kopyalama baÅŸarÄ±sÄ±z.</div>`;
                }
                setTimeout(() => { resultMessage.innerHTML = '' }, 2000);
            });

            // 5. YENÄ° - CevabÄ± GÃ¶ster Butonu
            if (showAnswerBtn) {
                showAnswerBtn.addEventListener('click', () => {
                    if (currentRubrik) {
                        rubrikContent.innerHTML = currentRubrik; // <-- DÃœZELTÄ°LDÄ°: .innerHTML
                        rubrikContainer.classList.remove('hidden');
                    } else {
                        rubrikContent.innerHTML = "Rubrik (Cevap AnahtarÄ±) yÃ¼klenemedi."; // <-- DÃœZELTÄ°LDÄ°: .innerHTML
                        rubrikContainer.classList.remove('hidden');
                    }
                    showAnswerBtn.disabled = true;
                });
            }
            
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metin Üretim Aracı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: #a855f7; /* purple-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">

            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">
                Maarif SosyalLab
            </h1>

            <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png"  
                         alt="Maarif Logo" 
                         class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>

            <div class="flex items-center">
                <div id="user-avatar-initial" class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">K</div>
                <div class="ml-3">
                    <span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">Kullanıcı</span>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">

            <a id="link-metin-analiz" href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all">
                <i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i>
                <span>Metin Analiz</span>
            </a>
            <a id="link-soru-uretim" href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
                <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i>
                <span>Soru Üretim</span>
            </a>
            <a id="link-metin-olusturma" href="/metin-olusturma" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-600 ring-2 ring-purple-300 transition-all">
                <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i>
                <span>Metin Oluşturma</span>
            </a>
            <a id="link-haritada-bul" href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all">
                <i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i>
                <span>Haritada Bul</span>
            </a>
            <a id="link-podcast" href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
                <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i>
                <span>Podcast Yap</span>
            </a>
            <a id="link-seyret-bul" href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all">
                <i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i>
                <span>Seyret Bul</span>
            </a>
            <a id="link-yarisma" href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-500 hover:bg-teal-600 transition-all">
                <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i>
                <span>Beceri/Değer Avcısı</span>
            </a>
            <a id="link-video-istegi" href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
                <i class="fa-solid fa-video mr-3 w-6 text-center"></i>
                <span>Video İsteği</span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <a href="/dashboard" class="flex items-center mx-2 p-2 rounded-lg text-gray-600 font-semibold bg-gray-100 hover:bg-gray-200 transition-all">
                <i class="fa-solid fa-arrow-left mr-3 w-6 text-center"></i>
                <span>Panele Geri Dön</span>
            </a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Metin Üretim Aracı</h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
                <form id="metin-form">

                    <div class="mb-4">
                        <label for="bilesen-kodu" class="block text-sm font-medium text-gray-700 mb-1">Süreç Bileşeni</label>
                        <select id="bilesen-kodu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" required>
                            <option value="">Lütfen bir süreç bileşeni seçin...</option>
                            </select>
                    </div>

                    <div class="mb-4">
                        <label for="metin-tipi" class="block text-sm font-medium text-gray-700 mb-1">Metin Tipi</label>
                        <select id="metin-tipi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" required disabled>
                            <option value="">Önce Süreç Bileşeni Seçin...</option>
                            </select>
                    </div>

                    <button type="submit" id="generate-btn" class="w-full bg-purple-500 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg hover:bg-purple-600 transition-all duration-300 flex items-center justify-center">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                        <span>Metin Üret</span>
                    </button>
                    <div id="loading-spinner" class="hidden flex items-center justify-center w-full bg-purple-300 text-purple-800 font-bold py-3 px-6 rounded-lg text-lg">
                        <div class="spinner mr-3"></div>
                        <span>Üretiliyor...</span>
                    </div>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Üretilen Metin</h3>
                    <div class="flex space-x-2">
                        <button id="copy-btn" title="Metni kopyala" class="text-gray-500 hover:text-blue-600"><i class="fa-solid fa-copy"></i></button>
                        <button id="save-btn" title="Metni kaydet (.txt)" class="text-gray-500 hover:text-green-600"><i class="fa-solid fa-save"></i></button>
                    </div>
                </div>

                <div id="result-message" class="mb-4"></div>

                <textarea id="result-text" class="w-full h-96 p-4 border border-gray-200 rounded-lg bg-gray-50 overflow-y-auto text-gray-700" placeholder="Üretilen metin burada görünecektir..."></textarea>

                <div class="text-sm text-gray-600 mt-2 flex justify-between">
                    <span>Kelime Sayısı: <span id="word-count" class="font-bold">0</span></span>
                    <span id="word-warning" class="text-yellow-600 font-semibold"></span>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Python'dan gelen ana veri yapısı (metin_uretim.PROMPT_SABLONLARI)
        const promptSablonlari = {{ prompt_sablonlari | tojson }};

        // DOM Elementleri
        const bilesenSelect = document.getElementById('bilesen-kodu');
        const metinTipiSelect = document.getElementById('metin-tipi');

        const metinForm = document.getElementById('metin-form');
        const generateBtn = document.getElementById('generate-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultText = document.getElementById('result-text');
        const resultMessage = document.getElementById('result-message');

        const wordCountSpan = document.getElementById('word-count');
        const wordWarningSpan = document.getElementById('word-warning');
        const copyBtn = document.getElementById('copy-btn');
        const saveBtn = document.getElementById('save-btn');

        document.addEventListener('DOMContentLoaded', () => {
            // --- Kullanıcı Adı Yükleme ---
            const userFullName = localStorage.getItem('loggedInUserName');
            const userRole = localStorage.getItem('loggedInUserRole'); // Rolü al

            if (userFullName) {
                document.getElementById('user-name-placeholder').textContent = userFullName;
                document.getElementById('user-avatar-initial').textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
            }
            
            // --- YENİ EKLENDİ: ROL KONTROLÜ ---
            const linkMetinAnaliz = document.getElementById('link-metin-analiz');
            const linkSoruUretim = document.getElementById('link-soru-uretim');
            const linkMetinOlusturma = document.getElementById('link-metin-olusturma');
            const linkHaritadaBul = document.getElementById('link-haritada-bul');
            const linkPodcast = document.getElementById('link-podcast');
            const linkSeyretBul = document.getElementById('link-seyret-bul');
            const linkYarisma = document.getElementById('link-yarisma');
            const linkVideoIstegi = document.getElementById('link-video-istegi');

            if (userRole === 'teacher') {
                // --- ÖĞRETMEN GÖRÜNÜMÜ ---
                // Öğrenci butonlarını gizle
                if (linkMetinAnaliz) linkMetinAnaliz.style.display = 'none';
                if (linkSeyretBul) linkSeyretBul.style.display = 'none';
                if (linkHaritadaBul) linkHaritadaBul.style.display = 'none'; 
                
                // Öğretmen butonları görünür kalsın (Zaten varsayılan 'flex')

            } else {
                // --- ÖĞRENCİ GÖRÜNÜMÜ ---
                // Öğretmen butonlarını gizle
                if (linkMetinOlusturma) linkMetinOlusturma.style.display = 'none';
                if (linkVideoIstegi) linkVideoIstegi.style.display = 'none';
            }
            // --- ROL KONTROLÜ BİTTİ ---


            // 1. Süreç Bileşeni Menüsünü Doldur
            for (const kod in promptSablonlari) {
                const data = promptSablonlari[kod];
                const option = document.createElement('option');
                option.value = kod;
                const kisaAciklama = data.aciklama.substring(0, 60) + '...';
                option.textContent = `${kod} - ${kisaAciklama}`;
                option.title = data.aciklama; // Tam açıklamayı başlık olarak ekle
                bilesenSelect.appendChild(option);
            }

            // 2. Süreç Bileşeni değiştiğinde Metin Tipi menüsünü güncelle
            bilesenSelect.addEventListener('change', () => {
                const selectedBilesenKodu = bilesenSelect.value;

                metinTipiSelect.innerHTML = '<option value="">Lütfen bir metin tipi seçin...</option>';

                if (selectedBilesenKodu && promptSablonlari[selectedBilesenKodu]) {
                    const metinTipleri = promptSablonlari[selectedBilesenKodu].metin_tipleri;

                    for (const tipAdi in metinTipleri) {
                        const option = document.createElement('option');
                        option.value = tipAdi;
                        option.textContent = tipAdi;
                        metinTipiSelect.appendChild(option);
                    }
                    metinTipiSelect.disabled = false;
                } else {
                    metinTipiSelect.disabled = true;
                    metinTipiSelect.innerHTML = '<option value="">Önce Süreç Bileşeni Seçin...</option>';
                }
            });

            // 3. Form Gönderme (Fetch API)
            metinForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const bilesenKodu = bilesenSelect.value;
                const metinTipiAdi = metinTipiSelect.value;

                console.log("Metin üretme isteği:", { bilesenKodu, metinTipiAdi });

                generateBtn.style.display = 'none';
                loadingSpinner.style.display = 'flex';
                resultText.value = 'Metniniz Üretiliyor, bu işlem biraz zaman alabilir...';
                resultMessage.innerHTML = '';

                try {
                    const response = await fetch('/api/generate-text', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bilesen_kodu: bilesenKodu,
                            metin_tipi_adi: metinTipiAdi
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        resultText.value = result.metin;
                        wordCountSpan.textContent = result.kelime_sayisi;
                        wordWarningSpan.textContent = result.uyari;
                        if(result.uyari) wordWarningSpan.classList.add('font-bold');
                        else wordWarningSpan.classList.remove('font-bold');

                        resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-green-100 text-green-800 text-sm">Metin başarıyla üretildi.</div>`;
                    } else {
                        resultText.value = '';
                        wordCountSpan.textContent = 0;
                        wordWarningSpan.textContent = '';
                        resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Hata: ${result.metin}</div>`;
                    }

                } catch (error) {
                    console.error("Metin üretme hatası:", error);
                    resultText.value = '';
                    wordCountSpan.textContent = 0;
                    wordWarningSpan.textContent = '';
                    resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-red-100 text-red-800 text-sm">Sunucuyla iletişim kurulamadı: Failed to fetch. API anahtarınızı kontrol edin.</div>`;
                } finally {
                    generateBtn.style.display = 'flex';
                    loadingSpinner.style.display = 'none';
                }
            });

            // 4. Yardımcı Butonlar (Kopyala, Kaydet)
            copyBtn.addEventListener('click', () => {
                resultText.select();
                document.execCommand('copy');
                resultMessage.innerHTML = `<div class="p-3 rounded-lg bg-blue-100 text-blue-800 text-sm">Metin panoya kopyalandı!</div>`;
                setTimeout(() => resultMessage.innerHTML = '', 2000);
            });

            saveBtn.addEventListener('click', () => {
                const text = resultText.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'uretilen_metin.txt';
                a.click();
            });
        });
    </script>
</body>
</html>

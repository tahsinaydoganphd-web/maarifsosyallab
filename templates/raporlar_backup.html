<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KullanÄ±m RaporlarÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">ðŸ“Š KullanÄ±m RaporlarÄ±</h1>
        
        <!-- Filtreler -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Filtreler</h2>
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">BaÅŸlangÄ±Ã§ Tarihi</label>
                    <input type="date" id="baslangic" class="border p-2 rounded w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">BitiÅŸ Tarihi</label>
                    <input type="date" id="bitis" class="border p-2 rounded w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Okul</label>
                    <select id="okul" class="border p-2 rounded w-full">
                        <option value="">TÃ¼m Okullar</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">SÄ±nÄ±f</label>
                    <select id="sinif" class="border p-2 rounded w-full">
                        <option value="">TÃ¼m SÄ±nÄ±flar</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-4 mt-4">
                <button onclick="raporGetir()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                    ðŸ“Š Rapor Getir
                </button>
                <button onclick="excelIndir()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                    ðŸ“¥ Excel Ä°ndir
                </button>
            </div>
        </div>

        <!-- Ã–zet Kartlar -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-600">Toplam KullanÄ±m</h3>
                <p class="text-3xl font-bold" id="toplamKullanim">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-600">En Aktif Ã–ÄŸrenci</h3>
                <p class="text-xl font-bold" id="enAktif">-</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-gray-600">En Ã‡ok KullanÄ±lan ModÃ¼l</h3>
                <p class="text-xl font-bold" id="enCokModul">-</p>
            </div>
        </div>

        <!-- Tablo -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">DetaylÄ± Rapor</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-left">Ã–ÄŸrenci No</th>
                            <th class="p-3 text-left">ModÃ¼l</th>
                            <th class="p-3 text-left">Tarih</th>
                            <th class="p-3 text-left">KullanÄ±m SayÄ±sÄ±</th>
                            <th class="p-3 text-left">Okul</th>
                            <th class="p-3 text-left">SÄ±nÄ±f</th>
                        </tr>
                    </thead>
                    <tbody id="raporBody">
                        <tr><td colspan="6" class="p-4 text-center text-gray-500">Filtre seÃ§ip "Rapor Getir" butonuna basÄ±n</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Sayfa yÃ¼klenirken okul ve sÄ±nÄ±f listelerini getir
        window.onload = async function() {
            const response = await fetch('/api/okul_sinif_listesi');
            const result = await response.json();
            
            if (result.success) {
                const okulSelect = document.getElementById('okul');
                result.okullar.forEach(okul => {
                    okulSelect.innerHTML += `<option value="${okul}">${okul}</option>`;
                });
                
                const sinifSelect = document.getElementById('sinif');
                result.siniflar.forEach(sinif => {
                    sinifSelect.innerHTML += `<option value="${sinif}">${sinif}</option>`;
                });
            }
        };

        async function raporGetir() {
            const baslangic = document.getElementById('baslangic').value;
            const bitis = document.getElementById('bitis').value;
            const okul = document.getElementById('okul').value;
            const sinif = document.getElementById('sinif').value;

            const params = new URLSearchParams();
            if (baslangic) params.append('baslangic', baslangic);
            if (bitis) params.append('bitis', bitis);
            if (okul) params.append('okul', okul);
            if (sinif) params.append('sinif', sinif);

            const response = await fetch(`/api/raporlar?${params}`);
            const result = await response.json();

            if (result.success) {
                gosterRapor(result.data);
            }
        }

        function excelIndir() {
            const baslangic = document.getElementById('baslangic').value;
            const bitis = document.getElementById('bitis').value;
            const okul = document.getElementById('okul').value;
            const sinif = document.getElementById('sinif').value;

            const params = new URLSearchParams();
            if (baslangic) params.append('baslangic', baslangic);
            if (bitis) params.append('bitis', bitis);
            if (okul) params.append('okul', okul);
            if (sinif) params.append('sinif', sinif);

            window.location.href = `/api/raporlar/excel?${params}`;
        }

        function gosterRapor(data) {
            const toplam = data.reduce((sum, row) => sum + row.kullanim_sayisi, 0);
            document.getElementById('toplamKullanim').textContent = toplam;

            const ogrenciGrup = {};
            data.forEach(row => {
                ogrenciGrup[row.student_no] = (ogrenciGrup[row.student_no] || 0) + row.kullanim_sayisi;
            });
            const enAktif = Object.keys(ogrenciGrup).reduce((a, b) => ogrenciGrup[a] > ogrenciGrup[b] ? a : b, '-');
            document.getElementById('enAktif').textContent = enAktif;

            const modulGrup = {};
            data.forEach(row => {
                modulGrup[row.modul_adi] = (modulGrup[row.modul_adi] || 0) + row.kullanim_sayisi;
            });
            const enCokModul = Object.keys(modulGrup).reduce((a, b) => modulGrup[a] > modulGrup[b] ? a : b, '-');
            document.getElementById('enCokModul').textContent = enCokModul;

            const tbody = document.getElementById('raporBody');
            tbody.innerHTML = '';
            data.forEach(row => {
                tbody.innerHTML += `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="p-3">${row.student_no}</td>
                        <td class="p-3">${row.modul_adi}</td>
                        <td class="p-3">${new Date(row.tarih).toLocaleDateString('tr-TR')}</td>
                        <td class="p-3 font-bold">${row.kullanim_sayisi}</td>
                        <td class="p-3">${row.okul}</td>
                        <td class="p-3">${row.sinif}</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>

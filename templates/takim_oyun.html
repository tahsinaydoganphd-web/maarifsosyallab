<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TakÄ±m YarÄ±ÅŸmasÄ± - Oyun EkranÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .team-item { transition: all 0.3s ease; }
        .team-item.active { background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: scale(1.02); }
        .team-item.inactive { opacity: 0.6; background-color: #fee2e2; border-color: #ef4444; } 
        
        .sentence { cursor: default; display: inline; padding: 2px 4px; margin: 0 2px; line-height: 2.2; border-radius: 4px; transition: all 0.2s ease-in-out; border: 1px solid transparent; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
        .sentence.clickable { cursor: pointer; }
        .sentence.clickable:hover { background-color: #dbeafe; border-color: #3b82f6; }
        .sentence.correct-beceri { background-color: #cffafe; border-color: #06b6d4; font-weight: 600; }
        .sentence.correct-deger { background-color: #dcfce7; border-color: #22c55e; font-weight: 600; }
        .sentence.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; font-weight: bold; opacity: 0.8; }
        
        .timer-bar-bg { height: 10px; background-color: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .timer-bar { height: 100%; background-color: #22c55e; width: 100%; transition: width 1s linear; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .control-btn.active-beceri { box-shadow: 0 0 0 3px #bfdbfe; background-color: #2563eb; }
        .control-btn.active-deger { box-shadow: 0 0 0 3px #bbf7d0; background-color: #16a34a; }
        
        #toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold; z-index: 50; transition: top 0.3s ease; }
        #toast-notification.show { top: 20px; }
        #toast-notification.success { background-color: #10b981; }
        #toast-notification.error { background-color: #ef4444; }
        #toast-notification.info { background-color: #3b82f6; }
        .no-bounce { overscroll-behavior: none; }
    </style>
</head>
<body class="flex h-screen"> <div id="toast-notification"></div>

    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">Maarif SosyalLab</h1>
            <div class="mb-4 flex justify-center"><img src="/videolar/maarif.png" class="h-24 object-contain rounded-lg"></div>
            <div class="flex items-center">
                <div id="user-avatar-initial" class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">K</div>
                <div class="ml-3"><span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">KullanÄ±cÄ±</span></div>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">
            <a href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all"><i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i><span>Metin Analiz</span></a>
            <a href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all"><i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i><span>Seyret Bul</span></a>
            <a href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-600 ring-2 ring-teal-300 transition-all"><i class="fa-solid fa-trophy mr-3 w-6 text-center"></i><span>Beceri/DeÄŸer AvcÄ±sÄ±</span></a>
            <a href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all"><i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i><span>Haritada Bul</span></a>
            <a href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all"><i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i><span>Podcast Yap</span></a>
            <a id="link-raporlar" href="/raporlar" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-gray-800 hover:bg-gray-900 transition-all shadow-sm">
                <i class="fa-solid fa-chart-line mr-3 w-6 text-center"></i><span>KullanÄ±m RaporlarÄ±</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <a id="btn-exit-game" href="#" class="flex items-center mx-2 p-2 rounded-lg text-gray-600 font-semibold bg-gray-100 hover:bg-gray-200 transition-all"><i class="fa-solid fa-arrow-left mr-3 w-6 text-center"></i><span>Panele Geri DÃ¶n</span></a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">
        <div id="game-container" class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">TakÄ±m YarÄ±ÅŸmasÄ±</h1>
                <div class="w-1/3">
                    <div id="timer-text" class="text-right font-bold text-xl mb-1">60</div>
                    <div class="timer-bar-bg"><div id="timer-bar" class="timer-bar"></div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-3 border-b pb-2">TakÄ±mlar</h2>
                    <div id="team-list-container" class="space-y-3"><div class="text-center text-gray-500 p-4">YÃ¼kleniyor...</div></div>
                </div>

                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h2 id="soru-numarasi-text" class="text-xl font-bold text-center text-blue-600 mb-4">YarÄ±ÅŸma BaÅŸlÄ±yor...</h2>
                    <div id="metin-container" class="bg-gray-50 p-4 rounded-lg min-h-[300px] max-h-[500px] overflow-y-auto text-lg leading-relaxed border">
                        <p class="text-gray-500 text-center p-8">SÄ±radaki takÄ±mÄ±n soruyu gÃ¶rebilmesi iÃ§in lÃ¼tfen 'Soruyu GÃ¶ster' butonuna basÄ±n.</p>
                    </div>
                </div>

                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-3 border-b pb-2">Kontrol Paneli</h2>
                    <button id="soru-goster-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg text-lg shadow hover:bg-blue-600 transition-all mb-2"><i class="fa-solid fa-eye mr-2"></i> Soruyu GÃ¶ster</button>
                    
                    <div class="mt-4 border-t pt-4">
                        <h3 class="font-semibold mb-2 text-gray-700">Aktif Butonlar:</h3>
                        <p id="kontrol-mesaj" class="text-sm text-gray-500 mb-3">Bekleniyor...</p>
                        <button id="btn-beceri" class="control-btn w-full p-3 rounded-lg font-semibold text-white bg-blue-400 hover:bg-blue-500 transition-all mb-2" disabled>Beceri</button>
                        <button id="btn-deger" class="control-btn w-full p-3 rounded-lg font-semibold text-white bg-green-400 hover:bg-green-500 transition-all" disabled>DeÄŸer</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full p-8 shadow-2xl text-center">
            <h2 id="tebrik-baslik" class="text-3xl font-bold text-yellow-500 mb-4">YarÄ±ÅŸma Bitti!</h2>
            <p id="tebrik-mesaj" class="text-lg text-gray-700 mb-6">...</p>
            <p id="yonlendirme-mesaj" class="text-sm text-gray-400 mt-2">...</p>
        </div>
    </div>

    <script>
        const YARISMA_ID = window.location.pathname.split('/').pop();
        let MY_USER_ID = ''; let MY_USER_ROLE = ''; let MY_USER_NAME = '';
        let AKTIF_TAKIM_ID = null; let AKTIF_SORU_NUMARASI = 0; let SECILI_BUTON_TIPI = null;
        let TIMER_INTERVAL = null; let DURUM_GUNCELLEME_INTERVAL = null; let KalanSaniye = 60;
        let TOAST_TIMER = null; let OYUN_KILITLI = false; let soruVerisi = null;
        let LAST_EVENT_TIME = 0; 

        const teamListContainer = document.getElementById('team-list-container');
        const soruNumarasiText = document.getElementById('soru-numarasi-text');
        const metinContainer = document.getElementById('metin-container');
        const soruGosterBtn = document.getElementById('soru-goster-btn');
        const btnBeceri = document.getElementById('btn-beceri');
        const btnDeger = document.getElementById('btn-deger');
        const kontrolMesaj = document.getElementById('kontrol-mesaj');
        const timerText = document.getElementById('timer-text');
        const timerBar = document.getElementById('timer-bar');
        const gameOverModal = document.getElementById('game-over-modal');
        const exitBtn = document.getElementById('btn-exit-game');

        document.addEventListener('DOMContentLoaded', () => {
            MY_USER_NAME = localStorage.getItem('loggedInUserName') || 'KullanÄ±cÄ±';
            MY_USER_ROLE = localStorage.getItem('loggedInUserRole');
            MY_USER_ID = String(localStorage.getItem('loggedInUserNo') || '').trim();

            document.getElementById('user-name-placeholder').textContent = MY_USER_NAME;
            document.getElementById('user-avatar-initial').textContent = MY_USER_NAME[0] || 'K';

            soruGosterBtn.addEventListener('click', soruGoster);
            btnBeceri.addEventListener('click', () => secimYap('beceri'));
            btnDeger.addEventListener('click', () => secimYap('deger'));
            
            if (exitBtn) {
                exitBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (MY_USER_ROLE === 'teacher') {
                        if (confirm("YarÄ±ÅŸmayÄ± sonlandÄ±rÄ±p Ã§Ä±kmak istiyor musunuz?")) {
                             const data = new FormData();
                             navigator.sendBeacon(`/api/takim/bitir/${YARISMA_ID}`, data);
                             window.location.href = '/dashboard';
                        }
                    } else {
                        window.location.href = '/yarisma-secim';
                    }
                });
            }
            
            window.addEventListener('pagehide', () => {
                if (MY_USER_ROLE === 'teacher') {
                    const data = new FormData();
                    navigator.sendBeacon(`/api/takim/bitir/${YARISMA_ID}`, data);
                }
            });

            getDurum();
            DURUM_GUNCELLEME_INTERVAL = setInterval(getDurum, 3000);
        });

        async function getDurum() {
            if (OYUN_KILITLI) return;
            try {
                let url = `/api/takim/get_durum/${YARISMA_ID}`;
                if (MY_USER_ROLE === 'teacher') url += '?ogretmen_burada=evet';

                const response = await fetch(url);
                if (!response.ok) throw new Error("Oyun bulunamadÄ±");

                const durum = await response.json();

                // EÄŸer oyun silindiyse
                if (!durum.success) {
                    clearInterval(DURUM_GUNCELLEME_INTERVAL);
                    showToast("YarÄ±ÅŸma sonlandÄ±. YÃ¶nlendiriliyorsunuz...", "error");
                    setTimeout(() => {
                        if (MY_USER_ROLE === 'student') window.location.href = '/yarisma-secim';
                        else window.location.href = '/dashboard';
                    }, 2000);
                    return;
                }

                // EÄŸer oyun bittiyse (10. soru veya elenme)
                if (durum.yarÄ±ÅŸma_bitti) {
                    oyunuBitir(durum);
                    return;
                }

                if (AKTIF_TAKIM_ID !== durum.aktif_takim_id) {
                    stopClientTimer();
                    resetSoruAlani();
                }

                AKTIF_TAKIM_ID = durum.aktif_takim_id;
                AKTIF_SORU_NUMARASI = durum.mevcut_soru_numarasi;
                renderTakimListesi(durum.takimlar, durum.aktif_takim_id);

                const kaptanId = String(durum.aktif_takim_kaptani_id || '').trim();
                const amICaptain = (MY_USER_ROLE === 'student' && MY_USER_ID === kaptanId);
                const isTeacher = (MY_USER_ROLE === 'teacher');
                
                // Son olay (Ä°zleyici iÃ§in)
                if (durum.son_olay && durum.son_olay.zaman > LAST_EVENT_TIME) {
                    LAST_EVENT_TIME = durum.son_olay.zaman;
                    showToast(durum.son_olay.mesaj, durum.son_olay.tur);
                    
                    const detay = durum.son_olay.detay;
                    if (detay && detay.sonuc === "yanlis" && detay.tiklanan_cumle) {
                         const yanlisEleman = document.querySelector(`.sentence[data-text="${detay.tiklanan_cumle}"]`);
                         if (yanlisEleman) {
                             yanlisEleman.classList.add('wrong');
                             setTimeout(() => yanlisEleman.classList.remove('wrong'), 2000);
                         }
                    }
                }

               // --- getDurum fonksiyonunun iÃ§indeki ilgili kÄ±sÄ±m ---

                if (durum.mevcut_soru_verisi) {
                    KalanSaniye = durum.kalan_saniye;
                    renderTimer(KalanSaniye);
                    soruVerisi = durum.mevcut_soru_verisi;
                    
                    const aktifTakim = durum.takimlar.find(t => t.id === durum.aktif_takim_id);
                    const beceriBulundu = aktifTakim ? aktifTakim.bulunan_beceri : false;
                    const degerBulundu = aktifTakim ? aktifTakim.bulunan_deger : false;

                    // --- YENÄ° EKLENEN: BENÄ°M TAKIMIM HANGÄ°SÄ°? ---
                    let myTeamId = null;
                    if (MY_USER_ROLE === 'student') {
                        durum.takimlar.forEach(t => {
                            t.uyeler.forEach(u => {
                                if (String(u.no).trim() === String(MY_USER_ID).trim()) {
                                    myTeamId = t.id;
                                }
                            });
                        });
                    }

                    // --- YENÄ° EKLENEN: GÃ–RÃœNÃœRLÃœK KONTROLÃœ ---
                    // EÄŸer Ã¶ÄŸretmensem VEYA benim takÄ±mÄ±mÄ±n sÄ±rasÄ±ysa soruyu gÃ¶ster
                    const isMyTurn = (myTeamId === durum.aktif_takim_id);
                    const isTeacher = (MY_USER_ROLE === 'teacher');

                    if (isTeacher || isMyTurn) {
                        // Soru EkranÄ±nÄ± Normal Ã‡iz
                        renderSoruAlani(soruVerisi.metin, soruVerisi.beceri_adi, soruVerisi.deger_adi, beceriBulundu, degerBulundu, amICaptain);
                        
                        // Buton durumlarÄ±nÄ± ayarla
                        btnBeceri.disabled = !amICaptain || beceriBulundu;
                        btnDeger.disabled = !amICaptain || degerBulundu;
                        
                        if (amICaptain) {
                            kontrolMesaj.textContent = "SÄ±ra SÄ°ZDE! (Kaptan)";
                            kontrolMesaj.className = "text-sm font-bold text-green-600 mb-3 animate-pulse";
                        } else {
                            kontrolMesaj.textContent = isTeacher ? `SÄ±ra: ${aktifTakim.isim}` : "TakÄ±mÄ±nÄ±z YarÄ±ÅŸÄ±yor...";
                            kontrolMesaj.className = "text-sm text-gray-500 mb-3";
                        }

                    } else {
                        // --- SIRA BENDE DEÄžÄ°LSE GÄ°ZLE ---
                        metinContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                                <i class="fa-solid fa-lock text-4xl mb-4 text-gray-300"></i>
                                <h3 class="text-xl font-bold text-gray-500">SÄ±ranÄ±zÄ± Bekleyin</h3>
                                <p class="text-sm mt-2">Åžu an <span class="text-blue-500 font-bold">${aktifTakim ? aktifTakim.isim : 'Rakip'}</span> yarÄ±ÅŸÄ±yor.</p>
                            </div>
                        `;
                        // ButonlarÄ± kilitle ve gizle
                        btnBeceri.textContent = "Bekleyiniz";
                        btnDeger.textContent = "Bekleyiniz";
                        btnBeceri.disabled = true;
                        btnDeger.disabled = true;
                        kontrolMesaj.textContent = "Rakip TakÄ±m Ä°zleniyor...";
                        kontrolMesaj.className = "text-sm text-gray-400 mb-3";
                    }
                    // ---------------------------------------------

                    soruGosterBtn.disabled = true;
                    soruGosterBtn.textContent = `${AKTIF_SORU_NUMARASI}. Soru GÃ¶sterildi`;

                    if (!TIMER_INTERVAL) startClientTimer(KalanSaniye);

                } else {
                    // Soru yoksa bekleme ekranÄ±
                    stopClientTimer();
                    resetSoruAlani();
                    soruGosterBtn.disabled = !isTeacher;
                    soruGosterBtn.style.display = isTeacher ? 'block' : 'none';
                    soruGosterBtn.textContent = `${AKTIF_SORU_NUMARASI}. Soruyu GÃ¶ster`;
                    kontrolMesaj.textContent = "SÄ±radaki soru bekleniyor...";
                } 

        function renderTakimListesi(takimlar, aktifTakimId) {
            teamListContainer.innerHTML = "";
            takimlar.forEach(takim => {
                const isTeamActive = takim.id === aktifTakimId;
                const isEliminated = !takim.aktif;
                const currentCaptainIndex = (takim.aktif_uye_index || 0) % takim.uyeler.length;
                
                const teamDiv = document.createElement('div');
                teamDiv.className = `team-item p-3 rounded-lg border-2 mb-3 transition-all ${isTeamActive ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 bg-white'} ${isEliminated ? 'inactive' : ''}`;
                
                let headerHtml = `
                    <div class="flex justify-between items-center mb-2 border-b pb-1">
                        <span class="font-bold text-lg ${isTeamActive ? 'text-blue-700' : 'text-gray-700'}">${takim.isim}</span>
                        <span class="font-bold text-xl ${isTeamActive ? 'text-blue-600' : 'text-gray-500'}">${takim.puan} P</span>
                    </div>
                `;

                let membersHtml = '<div class="flex flex-wrap gap-2 mb-2">';
                takim.uyeler.forEach((uye, index) => {
                    const isCaptain = (index === currentCaptainIndex);
                    const activeStyle = (isTeamActive && isCaptain) 
                        ? 'bg-green-500 text-white font-bold ring-2 ring-green-300 transform scale-105 shadow' 
                        : (isCaptain ? 'bg-gray-300 text-gray-600 font-semibold' : 'bg-gray-100 text-gray-500 text-xs');
                    
                    const kisaAd = uye.ad_soyad.split(' ')[0];
                    membersHtml += `<span class="px-2 py-1 rounded-md text-xs transition-all duration-300 ${activeStyle}">${isCaptain && isTeamActive ? 'â–¶ ' : ''}${kisaAd}</span>`;
                });
                membersHtml += '</div>';
                
                let rozetIkon = '';
                if(takim.rozet === 'bronz') rozetIkon = '<i class="fa-solid fa-medal text-yellow-700"></i>';
                if(takim.rozet === 'gÃ¼mÃ¼ÅŸ') rozetIkon = '<i class="fa-solid fa-medal text-gray-400"></i>';
                if(takim.rozet === 'altin') rozetIkon = '<i class="fa-solid fa-medal text-yellow-400"></i>';

                let statusHtml = isEliminated ? '<span class="text-red-600 font-bold text-sm">ELENDÄ°</span>' : (isTeamActive ? '<span class="text-blue-600 font-semibold text-sm">SÄ±ra Sizde</span>' : 'Bekliyor');

                let footerHtml = `
                    <div class="flex justify-between items-center text-sm text-gray-500">
                       <span>${statusHtml}</span>
                       <div class="text-lg">${rozetIkon}</div>
                    </div>`;

                teamDiv.innerHTML = headerHtml + membersHtml + footerHtml;
                teamListContainer.appendChild(teamDiv);
            });
        }

        function renderSoruAlani(metin, beceriAdi, degerAdi, beceriBulundu, degerBulundu, amICaptain) {
            metinContainer.innerHTML = "";
            soruNumarasiText.textContent = `${AKTIF_SORU_NUMARASI}. Soru`;
            const sentences = metin.match(/[^.!?]+[.!?]+/g) || [metin];
            
            sentences.forEach(sentenceText => {
                const cleanText = sentenceText.trim();
                const span = document.createElement('span');
                span.textContent = cleanText + ' ';
                span.className = 'sentence'; 
                
                if (amICaptain) { 
                    span.classList.add('clickable');
                    span.onclick = (e) => { e.preventDefault(); cevapVer(cleanText); }; 
                } 
                
                if (soruVerisi) { 
                    if (beceriBulundu && cleanText === soruVerisi.beceri_cumlesi) span.className = 'sentence correct-beceri';
                    if (degerBulundu && cleanText === soruVerisi.deger_cumlesi) span.className = 'sentence correct-deger';
                }
                metinContainer.appendChild(span);
            });
            btnBeceri.textContent = beceriAdi; 
            btnDeger.textContent = degerAdi;
        }

        async function cevapVer(tiklananCumleMetni) {
            if (OYUN_KILITLI || (KalanSaniye <= 0 && tiklananCumleMetni !== "SÃœRE DOLDU")) return;
            
            if (!SECILI_BUTON_TIPI && tiklananCumleMetni !== "SÃœRE DOLDU") {
                showToast("LÃ¼tfen Ã¶nce bir buton seÃ§in.", "info");
                return;
            }

            OYUN_KILITLI = true;
            btnBeceri.disabled = true; btnDeger.disabled = true;

            try {
                const response = await fetch(`/api/takim/cevap_ver/${YARISMA_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        takim_id: AKTIF_TAKIM_ID, 
                        tiklanan_tip: SECILI_BUTON_TIPI, 
                        tiklanan_cumle: tiklananCumleMetni 
                    })
                });
                const result = await response.json();
                
                // ðŸ‘‡ðŸ‘‡ðŸ‘‡ YENÄ° EKLENEN KISIM: OYUN BÄ°TTÄ° MÄ°? ðŸ‘‡ðŸ‘‡ðŸ‘‡
                if (result.sonuc === "oyun_bitti") {
                    // BÃ¼yÃ¼k bir kutu aÃ§, konfetiler patlasÄ±n, 10 saniye bekle
                    Swal.fire({
                        title: 'TEBRÄ°KLER!',
                        text: result.mesaj, // "KAZANDINIZ!" veya "X TakÄ±mÄ± KazandÄ±"
                        icon: 'success',
                        timer: 10000, // 10 Saniye bekle
                        timerProgressBar: true,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        willClose: () => {
                            // SÃ¼re dolunca Ana Panele git
                            window.location.href = "/panel"; 
                        }
                    });
                    return; // Fonksiyonu burada kes, baÅŸka iÅŸlem yapmasÄ±n.
                }
                // ðŸ‘†ðŸ‘†ðŸ‘† YENÄ° KISIM BÄ°TTÄ° ðŸ‘†ðŸ‘†ðŸ‘†

                if (result.sonuc === "yanlis") {
                    showToast("YanlÄ±ÅŸ!", "error");
                    getDurum(); 
                } else if (result.sonuc === "dogru_parca") {
                    showToast("DoÄŸru ParÃ§a!", "success");
                } else {
                    // Elendi, Tur Bitti veya DiÄŸer durumlar
                    if (result.sonuc === "elendi") {
                        showToast(result.mesaj, "error");
                        kontrolMesaj.textContent = result.mesaj;
                        kontrolMesaj.className = "text-sm font-bold text-red-600 mb-3";
                    } else {
                        showToast(result.mesaj, "success");
                    }
                    
                    stopClientTimer();
                    
                    // EÄŸer tur bittiyse veya elendiyse 3 saniye sonra diÄŸer takÄ±ma geÃ§
                    if(result.sonuc === "tur_bitti" || result.sonuc === "elendi") {
                        setTimeout(siradakiTakimaGec, 3000);
                    }
                    // Not: oyun_bitti kontrolÃ¼nÃ¼ en yukarÄ± aldÄ±ÄŸÄ±mÄ±z iÃ§in buradaki eski kodu sildik.
                    else { 
                        resetSoruAlani(); 
                    } 
                }
            } catch(e) { console.error(e); }
            finally { OYUN_KILITLI = false; }
        }

        async function soruGoster() {
            soruGosterBtn.disabled = true;
            await fetch(`/api/takim/soru_goster/${YARISMA_ID}`);
            getDurum();
        }
        async function siradakiTakimaGec() {
            await fetch(`/api/takim/siradaki_takim/${YARISMA_ID}`);
            getDurum();
        }

        function resetSoruAlani() {
             metinContainer.innerHTML = '<p class="text-gray-500 text-center p-8">SÄ±radaki soru bekleniyor...</p>';
             btnBeceri.textContent = "Beceri"; btnDeger.textContent = "DeÄŸer";
             btnBeceri.disabled = true; btnDeger.disabled = true;
        }
        function secimYap(tip) {
            SECILI_BUTON_TIPI = tip;
            if (tip === 'beceri') { btnBeceri.classList.add('active-beceri'); btnDeger.classList.remove('active-deger'); } 
            else { btnDeger.classList.add('active-deger'); btnBeceri.classList.remove('active-beceri'); }
        }
        function startClientTimer(saniye) {
            stopClientTimer(); KalanSaniye = saniye; renderTimer(KalanSaniye);
            TIMER_INTERVAL = setInterval(() => {
                KalanSaniye--; renderTimer(KalanSaniye);
                if (KalanSaniye <= 0) { stopClientTimer(); cevapVer("SÃœRE DOLDU"); }
            }, 1000);
        }
        function stopClientTimer() { clearInterval(TIMER_INTERVAL); TIMER_INTERVAL = null; }
        function renderTimer(s) { timerText.textContent = s; timerBar.style.width = `${(s/60)*100}%`; }
        function showToast(msg, type='info') {
            const t = document.getElementById('toast-notification');
            if (TOAST_TIMER) clearTimeout(TOAST_TIMER);
            t.textContent = msg; t.className = `show ${type}`;
            TOAST_TIMER = setTimeout(() => t.className = '', 3000);
        }
        
        // --- NÄ°HAÄ° Ã‡IKIÅž MANTIÄžI (DÃ¼zeltilmiÅŸ) ---
        function oyunuBitir(durum) {
            // EÄŸer zaten bitiÅŸ iÅŸlemi yapÄ±lÄ±yorsa tekrar yapma (DÃ¶ngÃ¼ Ã–nleyici)
            if (OYUN_BITTI_ISLENIYOR) return;
            OYUN_BITTI_ISLENIYOR = true;

            clearInterval(DURUM_GUNCELLEME_INTERVAL); 
            stopClientTimer();
            
            const kazanan = durum.takimlar.find(t => t.id === durum.kazanan_takim_id);
            const mesaj = kazanan ? `Kazanan: ${kazanan.isim}` : "Herkes elendi.";
            
            document.getElementById('tebrik-mesaj').textContent = mesaj;
            gameOverModal.classList.remove('hidden');
            
            // Skoru kaydet (Sadece Ã¶ÄŸretmen veya sistem otomatik tetiklerse)
            // fetch isteÄŸini burada tekrar atmaya gerek yok, zaten server bitirmiÅŸ.
            
            const mesajAlani = document.getElementById('yonlendirme-mesaj');
            
            if (durum.dereceye_girdi_mi) {
                mesajAlani.textContent = "Dereceye girdiniz! 5 sn sonra Liderlik Tablosu aÃ§Ä±lÄ±yor...";
                setTimeout(() => {
                    window.location.href = '/takim-liderlik-tablosu';
                }, 5000); // SÃ¼reyi biraz uzattÄ±m (5sn) ki yazÄ±yÄ± okuyabilsinler
            } else {
                mesajAlani.textContent = "5 sn sonra ana menÃ¼ye dÃ¶nÃ¼lÃ¼yor...";
                setTimeout(() => {
                    if (MY_USER_ROLE === 'student') window.location.href = '/yarisma-secim';
                    else window.location.href = '/dashboard';
                }, 5000);
            }
        }
    </script>
</body>
</html>




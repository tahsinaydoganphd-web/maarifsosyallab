<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maarif Model Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* YENÄ° EKLENDÄ°: macOS "esneme" (bounce) efektini kapat */
        .no-bounce {
            overscroll-behavior: none;
        }
    </style>
</head>

<body class="flex h-screen">

    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">

            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">
                Maarif SosyalLab
            </h1>

            <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png" alt="Maarif Logo"
                        class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>

            <div class="flex items-center">
                <div id="user-avatar-initial"
                    class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">
                    K
                </div>
                <div class="ml-3">
                    <span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">KullanÄ±cÄ±</span>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">

                    <a id="link-soru-uretim" href="/soru-uretim"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
                        <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i>
                        <span>Soru Ãœretim</span>
                    </a>
                    <a id="link-metin-olusturma" href="/metin-olusturma"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-500 hover:bg-purple-600 transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i>
                        <span>Metin OluÅŸturma</span>
                    </a>
                    <a id="link-podcast" href="/podcast_paneli"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
                        <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i>
                        <span>Podcast Yap</span>
                    </a>
                    <a id="link-yarisma" href="/yarisma-secim"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-500 hover:bg-teal-600 transition-all">
                        <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i>
                        <span>Beceri/DeÄŸer AvcÄ±sÄ±</span>
                    </a>
                    <a id="link-video-istegi" href="/video-istegi"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
                        <i class="fa-solid fa-video mr-3 w-6 text-center"></i>
                        <span>Video Ä°steÄŸi</span>
                    </a>
                    <a id="link-raporlar" href="javascript:void(0)" onclick="openRaporlarModal()"
                        class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-gray-700 hover:bg-gray-800 transition-all">
                        <i class="fa-solid fa-chart-line mr-3 w-6 text-center"></i>
                        <span>KullanÄ±m RaporlarÄ±</span>
                    </a>
                    
                </nav>

        <div class="p-4 border-t border-gray-200">
            <a href="/"
                class="flex items-center mx-2 p-2 rounded-lg text-red-600 font-semibold bg-gray-100 hover:bg-red-100 hover:text-red-700 transition-all">
                <i class="fa-solid fa-right-from-bracket mr-3 w-6 text-center"></i>
                <span>Ã‡Ä±kÄ±ÅŸ</span>
            </a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-3xl font-bold text-gray-800">HoÅŸ Geldiniz!</h2>
            <p class="text-gray-600 mt-2">
                LÃ¼tfen sol menÃ¼den bir araÃ§ seÃ§erek baÅŸlayÄ±n.
            </p>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. KullanÄ±cÄ± Bilgilerini YÃ¼kle
            const userFullName = localStorage.getItem('loggedInUserName');
            const userRole = localStorage.getItem('loggedInUserRole');
            const userNo = localStorage.getItem('loggedInUserNo');
            const userSchool = localStorage.getItem('loggedInUserSchool');
            const userClass = localStorage.getItem('loggedInUserClass');

            // 2. Ä°sim ve AvatarÄ± Ayarla
            if (userFullName) {
                const namePlaceholder = document.getElementById('user-name-placeholder');
                const avatarInitial = document.getElementById('user-avatar-initial');
                if (namePlaceholder) namePlaceholder.textContent = userFullName;
                if (avatarInitial) avatarInitial.textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
            }

            // 3. MenÃ¼ Rol KontrolÃ¼ (Ã–ÄŸretmen/Ã–ÄŸrenci FarkÄ±)
            const linkMetinAnaliz = document.getElementById('link-metin-analiz');
            const linkSoruUretim = document.getElementById('link-soru-uretim');
            const linkMetinOlusturma = document.getElementById('link-metin-olusturma');
            const linkHaritadaBul = document.getElementById('link-haritada-bul');
            const linkPodcast = document.getElementById('link-podcast');
            const linkSeyretBul = document.getElementById('link-seyret-bul');
            const linkYarisma = document.getElementById('link-yarisma');
            const linkVideoIstegi = document.getElementById('link-video-istegi');
            const linkRaporlar = document.getElementById('link-raporlar'); // Rapor butonu

            // Ã–ÄŸretmen iÃ§in butonlarÄ± gizle
            if (userRole === "teacher") {
                if (linkMetinAnaliz) linkMetinAnaliz.style.display = "none";
                if (linkHaritadaBul) linkHaritadaBul.style.display = "none";
                if (linkSeyretBul) linkSeyretBul.style.display = "none";
                const btnBireyselYarisma = document.getElementById("btn-bireysel-yarisma");
                if (btnBireyselYarisma) btnBireyselYarisma.style.display = "none";
                const btnBireyselSonuclar = document.getElementById("btn-bireysel-sonuclar");
                if (btnBireyselSonuclar) btnBireyselSonuclar.style.display = "none";
            } else {
                // Ã–ÄžRENCÄ°: Ã–ÄŸretmen araÃ§larÄ±nÄ± gizle
                if (linkMetinOlusturma) linkMetinOlusturma.style.display = 'none';
                if (linkRaporlar) linkRaporlar.style.display = 'none'; // Ã–ÄžRENCÄ° RAPORLARI GÃ–REMEZ

                const btnTakimYarisma = document.getElementById('btn-takim-yarisma');
                if (btnTakimYarisma) btnTakimYarisma.style.display = 'none';

                // ============================================================
                // ðŸ‘‡ðŸ‘‡ðŸ‘‡ GÄ°RÄ°Åž ANINDA PING VE OTO-GÄ°RÄ°Åž SÄ°STEMÄ° ðŸ‘‡ðŸ‘‡ðŸ‘‡
                // ============================================================
                if (userNo) {

                    // A. PING AT (Ã–ÄŸretmen beni yeÅŸil gÃ¶rsÃ¼n)
                    function sendPing() {
                        fetch('/api/ping', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ student_no: userNo })
                        }).catch(err => console.error("Ping hatasÄ±:", err));
                    }

                    // B. OYUN KONTROL ET (BaÅŸlamÄ±ÅŸ oyun varsa Ä±ÅŸÄ±nlan)
                    function checkForGame() {
                        if (!userSchool || !userClass) return;


                        fetch("/api/check_for_game", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ okul: userSchool, sinif: userClass })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.found && data.yarisma_id) {
                                    console.log("ðŸŸ¢ OYUN BULUNDU! YÃ¶nlendiriliyor...");
                                    window.location.href = `/takim-oyun-ekrani/${data.yarisma_id}`;
                                }
                            })
                            .catch(err => console.error("Oyun kontrol hatasÄ±:", err));
                    }

                    // Sisteme girer girmez baÅŸlat
                    sendPing();
                    checkForGame();

                    // Arka planda devam et (3 saniyede bir)
                    setInterval(() => {
                        sendPing();
                        checkForGame();
                    }, 3000);
                }
                // ============================================================
            }
        });

        // ===== RAPORLAR MODAL FONKSÄ°YONLARI =====
        let raporData = [];
        
        window.openRaporlarModal = function() {
            document.getElementById("raporlar-modal").classList.remove("hidden");
            loadRaporFilters();
        }
        
        window.closeRaporlarModal = function() {
            document.getElementById("raporlar-modal").classList.add("hidden");
        }
        
        async function loadRaporFilters() {
            const userRole = localStorage.getItem("loggedInUserRole");
            const userSchool = localStorage.getItem("loggedInUserSchool");
            const userClass = localStorage.getItem("loggedInUserClass");
            const container = document.getElementById("rapor-filtre-container");
            
            if (userRole === "teacher") {
                container.className = "grid grid-cols-2 gap-4 mb-4";
                container.innerHTML = `<div><label class="block text-sm font-medium mb-2">YÄ±l</label><select id="rapor-yil" class="border p-2 rounded w-full"><option value="">SeÃ§iniz</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option></select></div><div><label class="block text-sm font-medium mb-2">Ay</label><select id="rapor-ay" class="border p-2 rounded w-full" disabled><option value="">Ã–nce yÄ±l seÃ§in</option></select></div>`;
            } else {
                container.className = "grid grid-cols-4 gap-4 mb-4";
                container.innerHTML = `<div><label class="block text-sm font-medium mb-2">Okul</label><select id="rapor-okul" class="border p-2 rounded w-full"><option value="">SeÃ§iniz</option></select></div><div><label class="block text-sm font-medium mb-2">SÄ±nÄ±f</label><select id="rapor-sinif" class="border p-2 rounded w-full"><option value="">SeÃ§iniz</option></select></div><div><label class="block text-sm font-medium mb-2">YÄ±l</label><select id="rapor-yil" class="border p-2 rounded w-full"><option value="">SeÃ§iniz</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option></select></div><div><label class="block text-sm font-medium mb-2">Ay</label><select id="rapor-ay" class="border p-2 rounded w-full" disabled><option value="">Ã–nce yÄ±l seÃ§in</option></select></div>`;
                const res = await fetch("/api/okul_sinif_listesi");
                const data = await res.json();
                if (data.success) {
                    const okulSel = document.getElementById("rapor-okul");
                    const sinifSel = document.getElementById("rapor-sinif");
                    data.okullar.forEach(o => okulSel.innerHTML += `<option value="${o}">${o}</option>`);
                    data.siniflar.forEach(s => sinifSel.innerHTML += `<option value="${s}">${s}</option>`);
                }
            }
            document.getElementById("rapor-yil").addEventListener("change", function() {
                const yil = this.value, aySel = document.getElementById("rapor-ay");
                aySel.innerHTML = "<option value=\"\">SeÃ§iniz</option>";
                if (yil === "2025") aySel.innerHTML += "<option value=\"2025-11\">KasÄ±m 2025</option><option value=\"2025-12\">AralÄ±k 2025</option>";
                else if (yil) ["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"].forEach((a,i) => { const no = String(i+1).padStart(2,"0"); aySel.innerHTML += `<option value="${yil}-${no}">${a} ${yil}</option>`; });
                aySel.disabled = !yil;
            });
            setupRaporAutoLoad(userRole, userSchool, userClass);
        }
        
        function setupRaporAutoLoad(role, school, sinif) {
            const aySel = document.getElementById("rapor-ay");
            if (role === "teacher") {
                aySel.addEventListener("change", () => { if (aySel.value) getRapor(school, sinif, aySel.value); });
            } else {
                const okulSel = document.getElementById("rapor-okul"), sinifSel = document.getElementById("rapor-sinif");
                [okulSel, sinifSel, aySel].forEach(el => el.addEventListener("change", () => { if (okulSel.value && sinifSel.value && aySel.value) getRapor(okulSel.value, sinifSel.value, aySel.value); }));
            }
            document.getElementById("btn-rapor-excel").onclick = () => {
                const okul = role === "teacher" ? school : document.getElementById("rapor-okul").value;
                const snf = role === "teacher" ? sinif : document.getElementById("rapor-sinif").value, ay = aySel.value;
                if (!okul || !snf || !ay) { alert("LÃ¼tfen tÃ¼m filtreleri seÃ§in!"); return; }
                window.location.href = `/api/raporlar/excel?okul=${encodeURIComponent(okul)}&sinif=${encodeURIComponent(snf)}&ay=${ay}`;
            };
        }
        
        async function getRapor(okul, sinif, ay) {
            const res = await fetch(`/api/raporlar/haftalik?okul=${encodeURIComponent(okul)}&sinif=${encodeURIComponent(sinif)}&ay=${ay}`);
            const result = await res.json();
            if (result.success && result.data) {
                raporData = result.data;
                const tbody = document.getElementById("rapor-tbody-modal");
                tbody.innerHTML = "";
                result.data.forEach(row => { const ad = (row.first_name||"")+" "+(row.last_name||""); tbody.innerHTML += `<tr><td class="p-3">Hafta ${row.hafta}</td><td class="p-3">${row.student_no}</td><td class="p-3">${ad.trim()}</td><td class="p-3">${row.modul_adi}</td><td class="p-3">${row.kullanim}</td></tr>`; });
                const modSay={}, ogrKul={};
                result.data.forEach(r => { modSay[r.modul_adi]=(modSay[r.modul_adi]||0)+r.kullanim; const ad=((r.first_name||"")+" "+(r.last_name||"")).trim(); ogrKul[ad]=(ogrKul[ad]||0)+r.kullanim; });
                const topMod=Object.entries(modSay).sort((a,b)=>b[1]-a[1]).slice(0,3);
                document.getElementById("rapor-top-moduller").innerHTML=topMod.map((m,i)=>`<div class="mb-2"><b>${i+1}.</b> ${m[0]} - <span class="text-blue-600 font-bold">${m[1]} kullanÄ±m</span></div>`).join("");
                const topOgr=Object.entries(ogrKul).sort((a,b)=>b[1]-a[1]).slice(0,3);
                document.getElementById("rapor-top-ogrenciler").innerHTML=topOgr.map((o,i)=>`<div class="mb-2"><b>${i+1}.</b> ${o[0]} - <span class="text-green-600 font-bold">${o[1]} kullanÄ±m</span></div>`).join("");
                document.getElementById("rapor-ozet").style.display="grid";
            }
        }
        
        window.raporSirala = function(alan) {
            if (raporData.length===0) return;
            raporData.sort((a,b)=>{ if(alan==="kullanim") return b.kullanim-a.kullanim; return String(a[alan]).localeCompare(String(b[alan])); });
            const tbody=document.getElementById("rapor-tbody-modal"); tbody.innerHTML="";
            raporData.forEach(row=>{ const ad=(row.first_name||"")+" "+(row.last_name||""); tbody.innerHTML+=`<tr><td class="p-3">Hafta ${row.hafta}</td><td class="p-3">${row.student_no}</td><td class="p-3">${ad.trim()}</td><td class="p-3">${row.modul_adi}</td><td class="p-3">${row.kullanim}</td></tr>`; });
        }
    </script>

    <!-- Raporlar Modal -->
    <div id="raporlar-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ðŸ“Š KullanÄ±m RaporlarÄ±</h2>
                <button onclick="closeRaporlarModal()" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-times text-2xl"></i></button>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div id="rapor-filtre-container" class="grid gap-4 mb-4"></div>
                <button id="btn-rapor-excel" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">ðŸ“¥ Excel Ä°ndir</button>
            </div>
            <div id="rapor-ozet" class="grid grid-cols-2 gap-4 mb-4" style="display:none;">
                <div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">En Fazla KullanÄ±lan 3 ModÃ¼l</h4><div id="rapor-top-moduller"></div></div>
                <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">En Aktif Ã–ÄŸrenciler</h4><div id="rapor-top-ogrenciler"></div></div>
            </div>
            <div class="overflow-auto"><table class="w-full border"><thead class="bg-gray-100"><tr>
                <th class="p-3 text-left border cursor-pointer hover:bg-gray-200" onclick="raporSirala('hafta')">Hafta â†•</th>
                <th class="p-3 text-left border cursor-pointer hover:bg-gray-200" onclick="raporSirala('student_no')">Ã–ÄŸrenci No â†•</th>
                <th class="p-3 text-left border cursor-pointer hover:bg-gray-200" onclick="raporSirala('ad_soyad')">AdÄ± SoyadÄ± â†•</th>
                <th class="p-3 text-left border cursor-pointer hover:bg-gray-200" onclick="raporSirala('modul')">ModÃ¼l â†•</th>
                <th class="p-3 text-left border cursor-pointer hover:bg-gray-200" onclick="raporSirala('kullanim')">KullanÄ±m â†•</th>
            </tr></thead><tbody id="rapor-tbody-modal"><tr><td colspan="5" class="p-4 text-center text-gray-500">Filtreleri seÃ§in</td></tr></tbody></table></div>
        </div>
    </div>

</body>

</html>

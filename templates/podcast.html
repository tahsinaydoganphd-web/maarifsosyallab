<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maarif Model Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* YENİ EKLENDİ: macOS "esneme" (bounce) efektini kapat */
        .no-bounce {
            overscroll-behavior: none;
        }
    </style>
</head>

<body class="flex h-screen">

    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">

            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">
                Maarif SosyalLab
            </h1>

            <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png" alt="Maarif Logo"
                        class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>

            <div class="flex items-center">
                <div id="user-avatar-initial"
                    class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">
                    K
                </div>
                <div class="ml-3">
                    <span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">Kullanıcı</span>
                </div>
            </div>
        </div>
             <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">
    
    {% if role == 'student' %}
        <a href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all">
            <i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i><span>Metin Analiz</span>
        </a>
        <a href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
            <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i><span>Soru Üretim</span>
        </a>
        <a href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all">
            <i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i><span>Haritada Bul</span>
        </a>
        <a href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
            <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i><span>Podcast Yap</span>
        </a>
        <a href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all">
            <i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i><span>Seyret Bul</span>
        </a>
        <a href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-500 hover:bg-teal-600 transition-all">
            <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i><span>Beceri/Değer Avcısı</span>
        </a>
        <a href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
            <i class="fa-solid fa-video mr-3 w-6 text-center"></i><span>Video İsteği</span>
        </a>

    {% else %}
        <a href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
            <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i><span>Soru Üretim</span>
        </a>
        <a href="/metin-olusturma" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-500 hover:bg-purple-600 transition-all">
            <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i><span>Metin Oluşturma</span>
        </a>
        <a href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
            <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i><span>Podcast Yap</span>
        </a>
        <a href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-500 hover:bg-teal-600 transition-all">
            <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i><span>Beceri/Değer Avcısı</span>
        </a>
        <a href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
            <i class="fa-solid fa-video mr-3 w-6 text-center"></i><span>Video İsteği</span>
        </a>
        <a href="javascript:void(0)" onclick="openRaporlarModal()" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-gray-700 hover:bg-gray-800 transition-all">
             <i class="fa-solid fa-chart-line mr-3 w-6 text-center"></i><span>Kullanım Raporları</span>
        </a>
    {% endif %}
</nav>
        <div class="p-4 border-t border-gray-200">
            <a href="/"
                class="flex items-center mx-2 p-2 rounded-lg text-red-600 font-semibold bg-gray-100 hover:bg-red-100 hover:text-red-700 transition-all">
                <i class="fa-solid fa-right-from-bracket mr-3 w-6 text-center"></i>
                <span>Çıkış</span>
            </a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Podcast Oluşturucu</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <p class="text-gray-600 mb-4">Lütfen "sohbet podcasti" yapılacak metni (En fazla 600 kelime) aşağıya yapıştırın.</p>

                    <form id="podcast-form">
                        <textarea id="text-input" 
                                  name="text_content"
                                  class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:outline-none resize-none text-gray-700"
                                  placeholder="Metninizi buraya yapıştırın..."></textarea>

                        <div id="word-count" class="text-right text-sm text-gray-500 mt-1">0 / 600 kelime</div>

                        <button id="generate-btn" type="submit" class="w-full mt-4 bg-red-500 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg hover:bg-red-600 transition-all duration-300 flex items-center justify-center">
                            <i class="fa-solid fa-microphone mr-2"></i> Sohbet Podcasti Oluştur
                        </button>
                    </form>

                    <div id="podcast-status" class="mt-4 font-semibold text-gray-700 text-center"></div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow flex flex-col justify-center items-center text-center min-h-[300px]">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 w-full text-left">Podcast Oynatıcı</h3>
                    
                    <div id="podcast-player-container" class="mt-4 p-4 w-full" style="display: none;">
                        <p class="text-sm text-gray-500 mb-3">Ses dosyası hazır!</p>
                        <audio id="audio-player" controls class="w-full"></audio>
                    </div>

                    <div id="player-placeholder" class="p-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                             <i class="fa-solid fa-microphone-lines text-3xl"></i>
                        </div>
                        <p class="text-gray-400">Podcast oluşturulduktan sonra<br>burada dinleyebilirsiniz.</p>
                    </div>
                </div>
            </div>
        </main>
      
        <script>
            (function() {
                // --- Kullanıcı Adı Yükleme (Soru Üretim'deki kodun aynısı) ---
                try {
                    const userFullName = localStorage.getItem('loggedInUserName');
                    const userRole = localStorage.getItem('loggedInUserRole');

                    if (userFullName) {
                        document.getElementById('user-name-placeholder').textContent = userFullName;
                        document.getElementById('user-avatar-initial').textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
                    }
                } catch (e) { console.error("Kullanıcı bilgisi hatası:", e); }

                // --- Podcast Mantığı ---
                const form = document.getElementById('podcast-form');
                const textArea = document.getElementById('text-input');
                const wordCountDisplay = document.getElementById('word-count');
                const button = document.getElementById('generate-btn');
                const status = document.getElementById('podcast-status');
                const playerContainer = document.getElementById('podcast-player-container');
                const placeholder = document.getElementById('player-placeholder');
                let audioPlayer = document.getElementById('audio-player');
                
                const wordLimit = 600;

                textArea.addEventListener('input', function() {
                    const text = textArea.value;
                    const words = text.split(/\s+/).filter(Boolean);
                    const wordCount = words.length;
                    wordCountDisplay.textContent = `${wordCount} / ${wordLimit} kelime`;

                    if (wordCount > wordLimit || wordCount === 0) {
                        wordCountDisplay.classList.add('text-red-500', 'font-bold');
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        wordCountDisplay.classList.remove('text-red-500', 'font-bold');
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }); 

                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const userText = textArea.value.trim();
                    if (!userText) return;

                    button.disabled = true;
                    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Hazırlanıyor...';
                    status.textContent = "Lütfen bekleyin...";
                    
                    try {
                        const response = await fetch('/generate-podcast', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: userText, student_no: localStorage.getItem('user_no') }), 
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            placeholder.style.display = 'none';
                            playerContainer.style.display = 'block';
                            audioPlayer.src = data.audio_url + '?' + new Date().getTime();
                            audioPlayer.play();
                            status.innerHTML = '<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> Başarıyla oluşturuldu!</span>';
                        } else {
                            status.innerHTML = '<span class="text-red-600">Hata: ' + (data.error || "Bilinmeyen hata") + '</span>';
                        }
                    } catch (error) {
                        status.innerHTML = '<span class="text-red-600">Bağlantı Hatası</span>';
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="fa-solid fa-microphone mr-2"></i> Sohbet Podcasti Oluştur';
                    }
                });

            })();
        </script>
    
</body>

</html>

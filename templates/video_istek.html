<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video İstek Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style> 
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
    /* YENİ EKLENDİ: Limit aşılırsa sayacı kırmızı yapar */
    #word-count.over-limit { color: #ef4444; font-weight: 600; }
    #gonder-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

    /* YENİ EKLENEN KURAL */
    .no-bounce {
        overscroll-behavior: none;
    }
</style>
</head>
<body class="flex h-screen">
    
    <aside class="w-72 bg-white text-gray-800 shadow-lg flex flex-col fixed h-full">
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-2xl font-extrabold text-blue-600 text-center tracking-wide mb-4">Maarif SosyalLab</h1>
            <div class="mb-4">
                <div class="w-full p-2 flex items-center justify-center overflow-hidden">
                    <img src="/videolar/maarif.png"  
                         alt="Maarif Logo" 
                         class="w-auto h-auto max-w-full max-h-24 object-contain rounded-lg">
                </div>
            </div>
            <div class="flex items-center">
                <div id="user-avatar-initial" class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold text-lg">K</div>
                <div class="ml-3"><span id="user-name-placeholder" class="block text-sm font-bold text-gray-800">Kullanıcı</span></div>
            </div>
        </div>
        
       <nav class="flex-1 overflow-y-auto p-2 space-y-1 no-bounce">

            <a id="link-metin-analiz" href="/metin-analiz" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 transition-all">
                <i class="fa-solid fa-file-pen mr-3 w-6 text-center"></i>
                <span>Metin Analiz</span>
            </a>
            <a id="link-soru-uretim" href="/soru-uretim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-all">
                <i class="fa-solid fa-circle-question mr-3 w-6 text-center"></i>
                <span>Soru Üretim</span>
            </a>
            <a id="link-metin-olusturma" href="/metin-olusturma" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-purple-500 hover:bg-purple-600 transition-all">
                <i class="fa-solid fa-wand-magic-sparkles mr-3 w-6 text-center"></i>
                <span>Metin Oluşturma</span>
            </a>
            <a id="link-haritada-bul" href="/haritada-bul" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-orange-500 hover:bg-orange-600 transition-all">
                <i class="fa-solid fa-map-location-dot mr-3 w-6 text-center"></i>
                <span>Haritada Bul</span>
            </a>
            <a id="link-podcast" href="/podcast_paneli" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-all">
                <i class="fa-solid fa-microphone-lines mr-3 w-6 text-center"></i>
                <span>Podcast Yap</span>
            </a>
            <a id="link-seyret-bul" href="/seyret-bul-liste" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition-all">
                <i class="fa-solid fa-magnifying-glass-plus mr-3 w-6 text-center"></i>
                <span>Seyret Bul</span>
            </a>
            <a id="link-yarisma" href="/yarisma-secim" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-teal-600 ring-2 ring-teal-300 transition-all">
                <i class="fa-solid fa-trophy mr-3 w-6 text-center"></i>
                <span>Beceri/Değer Avcısı</span>
            </a>
            <a id="link-video-istegi" href="/video-istegi" class="flex items-center mx-2 p-2 rounded-lg text-white font-semibold bg-pink-500 hover:bg-pink-600 transition-all">
                <i class="fa-solid fa-video mr-3 w-6 text-center"></i>
                <span>Video İsteği</span>
            </a>

        </nav>
        <div class="p-4 border-t border-gray-200">
            <a href="/dashboard" class="flex items-center mx-2 p-2 rounded-lg text-gray-600 font-semibold bg-gray-100 hover:bg-gray-200 transition-all">
                <i class="fa-solid fa-arrow-left mr-3 w-6 text-center"></i>
                <span>Panele Geri Dön</span>
            </a>
        </div>
    </aside>

    <main class="ml-72 flex-1 p-6 md:p-8 overflow-y-auto no-bounce">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Video İstek Paneli</h2>
        
        <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
            <p class="text-gray-600 mb-4">
                Oluşturulmasını istediğiniz video içeriğinin metnini veya konusunu (En fazla 800 kelime) buraya yazarak panel yöneticisine gönderebilirsiniz. 
            </p>
            
            <form id="istek-form">
                <label for="istek-metni" class="block text-sm font-medium text-gray-700 mb-2">İstek Metni:</label>
                <textarea id="istek-metni" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Lütfen videonun konusunu, kazanımını ve mümkünse örnek metnini buraya yapıştırın..."></textarea>
                
                <div id="word-count" class="text-right text-sm text-gray-500 mt-1">0 / 800 kelime</div>
                
                <div id="form-mesaj" class="mt-4 text-sm font-semibold"></div>
                
                <button type="submit" id="gonder-btn" class="w-full mt-4 bg-pink-500 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg hover:bg-pink-600 transition-all duration-300 flex items-center justify-center" disabled>
                    <i class="fa-solid fa-paper-plane mr-2"></i>
                    <span>İsteği Gönder</span>
                </button>
            </form>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userFullName = localStorage.getItem('loggedInUserName') || 'Öğretmen';
            const userRole = localStorage.getItem('loggedInUserRole');
            
            // --- Kullanıcı Adını Ayarla ---
            document.getElementById('user-name-placeholder').textContent = userFullName;
            document.getElementById('user-avatar-initial').textContent = userFullName[0] ? userFullName[0].toUpperCase() : 'K';
            
            // --- Rol Kontrolü (STANDART) ---
            const linkMetinAnaliz = document.getElementById('link-metin-analiz');
            const linkSoruUretim = document.getElementById('link-soru-uretim');
            const linkMetinOlusturma = document.getElementById('link-metin-olusturma');
            const linkHaritadaBul = document.getElementById('link-haritada-bul');
            const linkPodcast = document.getElementById('link-podcast');
            const linkSeyretBul = document.getElementById('link-seyret-bul');
            const linkYarisma = document.getElementById('link-yarisma');
            const linkVideoIstegi = document.getElementById('link-video-istegi');
             if (userRole === 'teacher') {
                // --- ÖĞRETMEN GÖRÜNÜMÜ ---
                if (linkMetinAnaliz) linkMetinAnaliz.style.display = 'none';
                if (linkSeyretBul) linkSeyretBul.style.display = 'none';
                if (linkHaritadaBul) linkHaritadaBul.style.display = 'none'; 
            } else {
                // --- ÖĞRENCİ GÖRÜNÜMÜ ---
                if (linkMetinOlusturma) linkMetinOlusturma.style.display = 'none';
                // HATALI SATIR BURADAN SİLİNDİ
            }

            // --- Form Gönderme ---
            const istekForm = document.getElementById('istek-form');
            const gonderBtn = document.getElementById('gonder-btn');
            const formMesaj = document.getElementById('form-mesaj');
            const istekMetni = document.getElementById('istek-metni');
            
            // --- YENİ EKLENDİ: Kelime Sayacı ve Buton Kontrolü ---
            const wordCountDisplay = document.getElementById('word-count');
            const wordLimit = 800;
            const minWordLimit = 10; // En az 10 kelime olsun

            istekMetni.addEventListener('input', () => {
                const text = istekMetni.value.trim();
                const words = text.split(/\s+/).filter(Boolean);
                const wordCount = words.length;
                
                wordCountDisplay.textContent = `${wordCount} / ${wordLimit} kelime`;
                
                if (wordCount > wordLimit) {
                    gonderBtn.disabled = true;
                    wordCountDisplay.classList.add('over-limit');
                    formMesaj.textContent = "Hata: İstek metni 800 kelime limitini aşıyor.";
                    formMesaj.className = "mt-4 text-sm font-semibold text-red-600";
                } else if (wordCount < minWordLimit) {
                    gonderBtn.disabled = true;
                    wordCountDisplay.classList.remove('over-limit');
                    if (wordCount > 0) { // Sadece bir şey yazmaya başladıysa mesaj göster
                         formMesaj.textContent = "Lütfen en az 10 kelime girin.";
                         formMesaj.className = "mt-4 text-sm font-semibold text-yellow-600";
                    }
                } else {
                    gonderBtn.disabled = false;
                    wordCountDisplay.classList.remove('over-limit');
                    formMesaj.textContent = "";
                }
            });
            
            // Sayfa yüklendiğinde sayacı çalıştır (buton disabled başlar)
            istekMetni.dispatchEvent(new Event('input')); 
            // --- Kelime Sayacı Bitti ---

            istekForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const metin = istekMetni.value.trim();
                
                if (metin.length === 0 || gonderBtn.disabled) return;
                
                gonderBtn.disabled = true;
                gonderBtn.textContent = "Gönderiliyor...";
                
                // --- YENİ EKLENDİ: Tüm kullanıcı verisini localStorage'dan oku ---
                const gonderen_isim = localStorage.getItem('loggedInUserName') || 'Bilinmiyor';
                const gonderen_rol = localStorage.getItem('loggedInUserRole') || 'Bilinmiyor';
                const gonderen_no = localStorage.getItem('loggedInUserNo') || '';
                
                // --- GÜNCELLENDİ: Rol fark etmeksizin okul/sınıf bilgisini al ---
                // (Adım 2'de öğrenci için de kaydetmeyi eklediğimiz için bu artık çalışacak)
                let gonderen_okul = localStorage.getItem('loggedInUserSchool') || '';
                let gonderen_sinif = localStorage.getItem('loggedInUserClass') || '';
                // --- BİTTİ ---

                try {
                    const response = await fetch('/api/video-istegi-gonder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        
                        // --- GÜNCELLENDİ: Tüm veriyi API'ye gönder ---
                        body: JSON.stringify({ 
                            istek_metni: metin,
                            isteyen_ogretmen: gonderen_isim, // Bu, 'isim' alanı için kullanılıyor
                            kullanici_rol: gonderen_rol,
                            kullanici_no: gonderen_no,
                            kullanici_okul: gonderen_okul,
                            kullanici_sinif: gonderen_sinif
                        })
                        // --- GÜNCELLEME BİTTİ ---
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        formMesaj.textContent = "İsteğiniz başarıyla yöneticiye iletildi. Teşekkür ederiz!";
                        formMesaj.className = "mt-4 text-sm font-semibold text-green-600";
                        istekMetni.value = ""; // Kutuyu temizle
                        istekMetni.dispatchEvent(new Event('input')); // Sayacı sıfırla
                    } else {
                        formMesaj.textContent = `Hata: ${result.hata || 'Bilinmeyen bir sorun oluştu.'}`;
                        formMesaj.className = "mt-4 text-sm font-semibold text-red-600";
                    }
                    
                } catch (error) {
                    formMesaj.textContent = "Sunucuyla iletişim kurulamadı.";
                    formMesaj.className = "mt-4 text-sm font-semibold text-red-600";
                } finally {
                    gonderBtn.textContent = "İsteği Gönder";
                }
            });
        });
    </script>
</body>
</html>
